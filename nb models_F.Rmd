---
title: "R Notebook"
output: html_notebook
editor_options:
  chunk_output_type: console
---

```{r}
library(DHARMa)
library(dplyr)
library(phyloseq)
library(ggpubr)
library(microbiome)
library(tidyr)
library(forcats)
library(RColorBrewer)
library(vegan)
library(forcats)
library(glmmTMB)
library(emmeans)
library(multcomp)
library(lme4)
#library (ggcheck)
library(data.table)
library(vcd)
```

########################################################################################################################
Correlation antagonists with nematode count

```{r}
load (file = 'ps-selected-only-ITS-filt-lowabd-no-neg-norep.RData')
ps.ITS.dna.t0 <- subset_samples(ps.ITS, nucleic.acid == "DNA" & time.point == "T0"& sample.type == "rhizo")
ps.ITS.rna.t0 <- subset_samples(ps.ITS, nucleic.acid == "RNA" & time.point == "T0"& sample.type == "rhizo")
ps.ITS.dna.t0@sam_data$readcount.tot <- readcount(ps.ITS.dna.t0)
ps.ITS.rna.t0@sam_data$readcount.tot <- readcount(ps.ITS.rna.t0)

ant.ITS.dna.t0.gen <- subset_taxa(ps.ITS.dna.t0, Genus %in% c("Orbilia", "Arthrobotrys", "Dactylella", "Dactylellina",
                                                                      "Drechmeria","Haptocillium", "Hirsutella", "Lecanicillium", 
                                                                      "Trichoderma", "Fusarium", "Penicillium", "Nematoctonus", 
                                                                      "Coprinus", "Coprinellus", "Stropharia", "Glomus", "Paraglomus", 
                                                                      "Mortierella", "Monacrosporium"))
ant.ITS.rna.t0.gen <- subset_taxa(ps.ITS.rna.t0, Genus %in% c("Orbilia", "Arthrobotrys", "Dactylella", "Dactylellina",
                                                                      "Drechmeria","Haptocillium", "Hirsutella", "Lecanicillium", 
                                                                      "Trichoderma", "Fusarium", "Penicillium", "Nematoctonus", 
                                                                      "Coprinus", "Coprinellus", "Stropharia", "Glomus", "Paraglomus", 
                                                                      "Mortierella", "Monacrosporium"))
```

```{r}
#DNA
ant.itsgen.dna.t0.s <- microbiome::aggregate_taxa(ant.ITS.dna.t0.gen, "Genus")
samdf.itsgen.dna.t0.s <-as.data.frame(sample_data (ant.itsgen.dna.t0.s))
otu.itsgen.dna.t0.s <- as.data.frame (t(otu_table(ant.itsgen.dna.t0.s)))
tax.itsgen.dna.t0.s <- as.data.frame(tax_table(ant.itsgen.dna.t0.s))

samdf.itsgen.dna.t0.s$readcount <- rowSums(otu.itsgen.dna.t0.s[1:18])

data.itsgen.dna.t0.s <- merge (samdf.itsgen.dna.t0.s, otu.itsgen.dna.t0.s,  by = 'row.names')
colnames(data.itsgen.dna.t0.s)

data.itsgen.dna.t0.s$pre.crop <- as.factor(data.itsgen.dna.t0.s$pre.crop)

#"Penicillium"    "Arthrobotrys"   "Dactylella"     "Dactylellina" "Monacrosporium" "Orbilia"        "Lecanicillium"  "Trichoderma" "Fusarium"       "Drechmeria"     "Haptocillium"   "Hirsutella" "Coprinus" "Nematoctonus"   "Coprinellus"    "Stropharia" "Paraglomus"     "Mortierella" 

data.itsgen.dna.t0.s$pre.crop <- fct_relevel(data.itsgen.dna.t0.s$pre.crop, "er", "ir", "ry", "bo")
ITS.antagonists <- c("Penicillium","Arthrobotrys","Dactylella","Dactylellina", "Monacrosporium", "Orbilia","Lecanicillium","Trichoderma", "Fusarium","Drechmeria","Haptocillium","Hirsutella","Coprinus","Nematoctonus","Coprinellus","Stropharia","Paraglomus","Mortierella")
```

```{r}
#RNA
ant.itsgen.rna.t0.s <- microbiome::aggregate_taxa(ant.ITS.rna.t0.gen, "Genus")
samdf.itsgen.rna.t0.s <-as.data.frame(sample_data (ant.itsgen.rna.t0.s))
otu.itsgen.rna.t0.s <- as.data.frame (t(otu_table(ant.itsgen.rna.t0.s)))
tax.itsgen.rna.t0.s <- as.data.frame(tax_table(ant.itsgen.rna.t0.s))
samdf.itsgen.rna.t0.s$readcount <- rowSums(otu.itsgen.rna.t0.s[1:18])

data.itsgen.rna.t0.s <- merge (samdf.itsgen.rna.t0.s, otu.itsgen.rna.t0.s,  by = 'row.names')
colnames(data.itsgen.rna.t0.s)

colnames(data.itsgen.rna.t0.s)
data.itsgen.rna.t0.s$pre.crop <- as.factor(data.itsgen.rna.t0.s$pre.crop)
#"Penicillium"    "Arthrobotrys"   "Dactylella"     "Dactylellina" "Monacrosporium" "Orbilia" "Lecanicillium"  "Trichoderma" "Fusarium"       "Drechmeria"     "Haptocillium"   "Hirsutella" "Coprinus"       "Nematoctonus"   "Coprinellus"    "Stropharia" "Paraglomus" "Mortierella"

data.itsgen.rna.t0.s$pre.crop <- fct_relevel(data.itsgen.rna.t0.s$pre.crop, "er", "ir", "ry", "bo")
```


#plots
```{r}
data.genits.dna.t0.s.long <- data.itsgen.dna.t0.s %>%
  dplyr::select(pre.crop,readcount.tot, Arthrobotrys, Fusarium, Mortierella,Trichoderma) %>% 
  tidyr::pivot_longer(cols = Arthrobotrys:Trichoderma, 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
              mutate (Rel.abundance.DNA = (Abundance/readcount.tot)) 
data.genits.dna.t0.s.long$pre.crop <- forcats::fct_relevel(data.genits.dna.t0.s.long$pre.crop, "bo", "ry", "ir", "er" )
  
data.genits.rna.t0.s.long <- data.itsgen.rna.t0.s %>% 
  dplyr::select(pre.crop,readcount.tot,Arthrobotrys, Fusarium, Mortierella,Trichoderma) %>% 
  tidyr::pivot_longer(cols = Arthrobotrys:Trichoderma, 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
  mutate (Rel.abundance.RNA = (Abundance/readcount.tot)) 
data.genits.rna.t0.s.long$pre.crop <- forcats::fct_relevel(data.genits.rna.t0.s.long$pre.crop, "bo", "ry", "ir", "er" )

#horizontal 
colorCode <- c(bo = "#D55E00", ry = "#E69F00", ir = "#F0E442",  er = "#009E73")

plot.ant.its.dna.t0h<- data.genits.dna.t0.s.long %>%  
                        ggplot (mapping = aes(y=Rel.abundance.DNA, x =pre.crop, fill = pre.crop))+
                        geom_boxplot(orientation = "x", fatten = 1)+
                        #geom_point(alpha = 0.5)+
                        scale_y_continuous(limits = c(0,0.06), labels = scales::percent)+
                        scale_fill_manual(values = colorCode)+
                        labs(title = "Relative abundance of antagonistic fungal genera in DNA", y = "Relative abundance")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow = 1)+
   theme_classic()+
  theme(axis.line.y.left = (element_blank()), 
        axis.text.x = (element_text(angle = 90, size = 10)),
        strip.text.x = element_text(size = 8))
plot.ant.its.dna.t0h

plot.ant.its.rna.t0h<- data.genits.rna.t0.s.long %>%  
                        ggplot (mapping = aes(y=Rel.abundance.RNA, x =pre.crop, fill = pre.crop))+
                        geom_boxplot(orientation = "x", fatten = 1)+
                        #geom_point(alpha = 0.5)+
                        scale_y_continuous(limits = c(0,0.06), labels = scales::percent)+
                        scale_color_manual(values = colorCode)+
                        scale_fill_manual(values = colorCode)+
                        labs(title = "Relative abundance of antagonistic fungal genera in RNA", y = "Relative abundance ")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow = 1)+
   theme_classic()+
  theme(axis.line.y.left = (element_blank()), 
        axis.text.x = (element_text(angle = 90, size = 10)),
        strip.text.x = element_text(size = 8))
plot.ant.its.rna.t0h

library(cowplot)
#ant.t0 <- plot_grid(plot.ant.bact.dna.t0h, 
#                    plot.ant.bact.rna.t0h,
#                    align = "hv",
#                    ncol = 1)
#ant.t0 

```


```{r}
library(cowplot)
ant.t0.double.dnaf <- plot_grid( plot.comp.dna.f,
                            plot.ant.its.dna.t0h,
                            align = "hv",
                            ncol = 2,
                            rel_widths = c(0.5,1),
                            scale = 1)
ant.t0.double.dnaf

ant.t0.double.rnaf <- plot_grid( plot.comp.rna.f,
                            plot.ant.its.rna.t0h,
                            align = "hv",
                            ncol = 2,
                            rel_widths = c(0.5,1),
                            scale = 1)
ant.t0.double.rnaf

ant.t0.fourf <- plot_grid(ant.t0.double.dnaf,
                         ant.t0.double.rnaf,
                         align = "hv",
                         nrow = 2,
                         rel_widths = c(0.5,1),
                          scale = 1)
ant.t0.fourf
```

for understanding output look at https://www.middleprofessor.com/files/applied-biostatistics_bookdown/_book/counts.html
reference : Negative binomial mixed models for analyzing microbiome count data, Zhang et al , 2017, https://doi.org/10.1186/s12859-016-1441-7

https://github.com/nyiuab/NBZIMM
```{r}
data.itsgen.dna.t0.s$Arthrobotrys #(12/12)
data.itsgen.dna.t0.s$Dactylella #(1>0)
data.itsgen.dna.t0.s$Dactylellina #(1>0)
data.itsgen.dna.t0.s$Monacrosporium #(NA)
data.itsgen.dna.t0.s$Orbilia #(NA)
data.itsgen.dna.t0.s$Lecanicillium #(1>0)
data.itsgen.dna.t0.s$Trichoderma #(12/12, all)
data.itsgen.dna.t0.s$Fusarium #(12/12)
data.itsgen.dna.t0.s$Drechmeria #(1>0)
data.itsgen.dna.t0.s$Haptocillium #(5/12)
data.itsgen.dna.t0.s$Hirsutella #(5/12)
data.itsgen.dna.t0.s$Coprinus #(NA)
data.itsgen.dna.t0.s$Coprinellus #(2/12)
data.itsgen.dna.t0.s$Stropharia #(NA)
data.itsgen.dna.t0.s$Paraglomus #(NA) 
data.itsgen.dna.t0.s$Mortierella #(12/12)
```


Arthrobotrys
```{r}
#######with glmtmb
data.itsgen.dna.t0.s$Arthrobotrys
hist(data.itsgen.dna.t0.s$Arthrobotrys,nclass = 1000)
boxplot(data.itsgen.dna.t0.s$Arthrobotrys ~ data.itsgen.dna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.dna.t0.s$Arthrobotrys)
distplot(data.itsgen.dna.t0.s$Arthrobotrys, type = "poisson") #fits a poisson
distplot(data.itsgen.dna.t0.s$Arthrobotrys, type = "nbinomial")

#Check if readcount is significant
arth.dna.readcount <- glmmTMB(Arthrobotrys ~ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family = nbinom1(link = "log"))
summary(arth.dna.readcount)
car::Anova(arth.dna.readcount)#0.01618
test <- simulateResiduals(fittedModel = arth.dna.readcount, plot = T, use.u = T)
#readcount is not significant but doesn't fit

#Check if block is significant
arth.dna.block <- glmmTMB(Arthrobotrys ~  block2, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.block)
car::Anova(arth.dna.block)
test <- simulateResiduals(fittedModel = arth.dna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
arth.dna.blockread <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.blockread)
car::Anova(arth.dna.blockread)
test <- simulateResiduals(fittedModel = arth.dna.blockread, plot = T, use.u = T)
#block2 is non-significant, readcount is not significant - but doesn't fit

#Check complete
arth.dna.complete <- glmmTMB(Arthrobotrys ~ pre.crop+ block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.complete)
car::Anova(arth.dna.complete)
test <- simulateResiduals(fittedModel = arth.dna.complete, plot = T, use.u = T)

anova(arth.dna.readcount,arth.dna.block, arth.dna.blockread, arth.dna.complete) #- use block as random

#test for pre crops
arth.dna.null <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
arth.dna.rand <- glmmTMB(Arthrobotrys ~  1 +(1|block2),
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log"))
arth.dna.pc <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.dna.pc, plot = T)
#doesn't fit - doesn't fit because pre crop doesn't explain anything - null model is better

arth.dna.pcrand <- glmmTMB(Arthrobotrys ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.dna.pcrand, plot = T)
car::Anova(arth.dna.pcrand)
#fits
#random term shouldn't be included but is the only that fits

anova(arth.dna.null,arth.dna.rand, arth.dna.pcrand,arth.dna.pc)

#block 2 significant, readcount ns= select model without offset
arth.dna.pc <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
summary(arth.dna.pc)
knitr::kable(summary(arth.dna.pc)$coefficients, digits = 4)
car::Anova (arth.dna.pc)

#check model
test <- simulateResiduals(fittedModel = arth.dna.pc, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(arth.dna.pc)

#EMMEANS
ref_grid(arth.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(arth.dna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


Fusarium
```{r}
#######with glmtmb
data.itsgen.dna.t0.s$Fusarium
hist(data.itsgen.dna.t0.s$Fusarium,nclass = 500)
boxplot(data.itsgen.dna.t0.s$Fusarium ~ data.itsgen.dna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.dna.t0.s$Fusarium)
distplot(data.itsgen.dna.t0.s$Fusarium, type = "poisson") #fits a poisson
distplot(data.itsgen.dna.t0.s$Fusarium, type = "nbinomial")

#Check if readcount is significant
fus.dna.readcount <- glmmTMB(Fusarium ~ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family = nbinom1(link = "log"))
summary(fus.dna.readcount)
car::Anova(fus.dna.readcount)#0.01618
test <- simulateResiduals(fittedModel = fus.dna.readcount, plot = T, use.u = T)
#readcount is non significant, fits

#Check if block is significant
fus.dna.block <- glmmTMB(Fusarium ~  block2, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.block)
car::Anova(fus.dna.block)
test <- simulateResiduals(fittedModel = fus.dna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
fus.dna.blockread <- glmmTMB(Fusarium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.blockread)
car::Anova(fus.dna.blockread)
test <- simulateResiduals(fittedModel = fus.dna.blockread, plot = T, use.u = T)
#block2 is non significant, readcount is significant, doesn't fit

#Check complete
fus.dna.blockreadpc <- glmmTMB(Fusarium ~  pre.crop+block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.blockreadpc)
car::Anova(fus.dna.blockreadpc)
test <- simulateResiduals(fittedModel = fus.dna.blockreadpc, plot = T, use.u = T)
#all significant

anova(fus.dna.readcount,fus.dna.block, fus.dna.blockread,fus.dna.blockreadpc) #- use block as random

#test for pre crops
fus.dna.null <- glmmTMB(Fusarium ~  1 ,
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
fus.dna.rand <- glmmTMB(Fusarium ~  1 +(1|block2),
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
fus.dna.pcrand <- glmmTMB(Fusarium ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.pcrand, plot = T)
#fits
fus.dna.pc <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.pc, plot = T)
#fits
fus.dna.pcrandoff <- glmmTMB(Fusarium ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.pcrandoff, plot = T) #fits

fus.dna.pcoff <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.pcoff, plot = T) #fits

anova(fus.dna.rand, fus.dna.pcrand, fus.dna.pcrandoff,fus.dna.null, fus.dna.readcount,fus.dna.block, fus.dna.blockread,fus.dna.pc)  
anova(fus.dna.pcrandoff,fus.dna.pcoff,fus.dna.pc,fus.dna.null )

#block 2 significant, readcount ns= select model without offset
fus.dna.pc <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.pc, plot = T)
summary(fus.dna.pc)
knitr::kable(summary(fus.dna.pc)$coefficients, digits = 4)
car::Anova (fus.dna.pc)

#check model
test <- simulateResiduals(fittedModel = fus.dna.pc, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(fus.dna.pc)

#EMMEANS
ref_grid(fus.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(fus.dna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Trichoderma
```{r}
#######with glmtmb
data.itsgen.dna.t0.s$Trichoderma
hist(data.itsgen.dna.t0.s$Trichoderma,nclass = 1000)
boxplot(data.itsgen.dna.t0.s$Trichoderma ~ data.itsgen.dna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.dna.t0.s$Trichoderma)
distplot(data.itsgen.dna.t0.s$Trichoderma, type = "poisson") #fits a poisson
distplot(data.itsgen.dna.t0.s$Trichoderma, type = "nbinomial")

#Check if readcount is significant
trich.dna.readcount <- glmmTMB(Trichoderma ~ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family = nbinom1(link = "log"))
summary(trich.dna.readcount)
car::Anova(trich.dna.readcount)#0.01618
test <- simulateResiduals(fittedModel = trich.dna.readcount, plot = T, use.u = T)
#readcount is significant and fits

#Check if block is significant
trich.dna.block <- glmmTMB(Trichoderma ~  block2, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.block)
car::Anova(trich.dna.block)
test <- simulateResiduals(fittedModel = trich.dna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
trich.dna.blockread <- glmmTMB(Trichoderma ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.blockread)
car::Anova(trich.dna.blockread)
test <- simulateResiduals(fittedModel = trich.dna.blockread, plot = T, use.u = T)
#block2 is non-significant, readcount is not significant - it fits

#Check complete
trich.dna.complete<- glmmTMB(Trichoderma ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.complete)
car::Anova(trich.dna.complete)
test <- simulateResiduals(fittedModel = trich.dna.complete, plot = T, use.u = T)
#nothing significant, doesn't fit

anova(trich.dna.readcount,trich.dna.block, trich.dna.blockread,trich.dna.complete) #- use without block , with offset

#test for pre crops
trich.dna.nulloff <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot)) 
trich.dna.pc <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.dna.pc, plot = T)
trich.dna.pcoff <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
#doesn't fit - doesn't fit because pre crop doesn't explain anything - null model is better
test <- simulateResiduals(fittedModel = trich.dna.pcoff, plot = T)
car::Anova(trich.dna.pcoff)
#fits
#random term shouldn't be included but is the only that fits

anova(trich.dna.nulloff,trich.dna.pcoff)

anova(trich.dna.pcoff,trich.dna.readcount,trich.dna.blockread )
#model null is better than model with pre crops > pre crops don't explain any variation

#use 
trich.dna.pcoff <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
summary(trich.dna.pcoff)
knitr::kable(summary(trich.dna.pcoff)$coefficients, digits = 4)
car::Anova (trich.dna.pcoff)

#check model
test <- simulateResiduals(fittedModel = trich.dna.pcoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(trich.dna.pcoff)

#EMMEANS
ref_grid(trich.dna.pcoff)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(trich.dna.pcoff, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Mortierella
```{r}
#######with glmtmb
data.itsgen.dna.t0.s$Mortierella
hist(data.itsgen.dna.t0.s$Mortierella,nclass = 1000)
boxplot(data.itsgen.dna.t0.s$Mortierella ~ data.itsgen.dna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.dna.t0.s$Mortierella)
distplot(data.itsgen.dna.t0.s$Mortierella, type = "poisson") #fits a poisson
distplot(data.itsgen.dna.t0.s$Mortierella, type = "nbinomial")

#Check if readcount is significant
mort.dna.readcount <- glmmTMB(Mortierella ~ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family = nbinom1(link = "log"))
summary(mort.dna.readcount)
car::Anova(mort.dna.readcount)
test <- simulateResiduals(fittedModel = mort.dna.readcount, plot = T, use.u = T)
#readcount is not significant, fits

#Check if block is significant
mort.dna.block <- glmmTMB(Mortierella ~  block2, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.block)
car::Anova(mort.dna.block)
test <- simulateResiduals(fittedModel = mort.dna.block, plot = T, use.u = T)
#block2 is not significant, fits

#Check if block + read is significant
mort.dna.blockread <- glmmTMB(Mortierella ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.blockread)
car::Anova(mort.dna.blockread)
test <- simulateResiduals(fittedModel = mort.dna.blockread, plot = T, use.u = T)
#block2 is significant, readcount is not significant

#Check if block + read  pre crop is significant
mort.dna.blockreadpc <- glmmTMB(Mortierella ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.blockreadpc)
car::Anova(mort.dna.blockreadpc)
test <- simulateResiduals(fittedModel = mort.dna.blockreadpc, plot = T, use.u = T)
#none is significant, no fit

#Check if block + read  pre crop is significant
mort.dna.blockpc <- glmmTMB(Mortierella ~  block2 +pre.crop, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.blockpc)
car::Anova(mort.dna.blockpc)
test <- simulateResiduals(fittedModel = mort.dna.blockpc, plot = T, use.u = T)
#no significant - no fit

#Check complete
mort.dna.complete <- glmmTMB(Mortierella ~  block2 +pre.crop+ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.complete)
car::Anova(mort.dna.complete)
test <- simulateResiduals(fittedModel = mort.dna.complete, plot = T, use.u = T)
#no significant - no fit

anova(mort.dna.readcount,mort.dna.block, mort.dna.blockread, mort.dna.blockpc,mort.dna.blockreadpc,mort.dna.null) #- use block as random

#test for pre crops
mort.dna.null <- glmmTMB(Mortierella ~  1 ,
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
mort.dna.rand <- glmmTMB(Mortierella ~  1 +(1|block2),
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
mort.dna.pcrand <- glmmTMB(Mortierella ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.dna.pcrand, plot = T)
#no fit
testZeroInflation(test)
mort.dna.pcrandoff <- glmmTMB(Mortierella ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
mort.dna.pc <- glmmTMB(Mortierella ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
mort.dna.pcoff <- glmmTMB(Mortierella ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
anova(mort.dna.rand, mort.dna.pcrand, mort.dna.pcrandoff, mort.dna.pc, mort.dna.null,mort.dna.pcoff) 
test <- simulateResiduals(fittedModel = mort.dna.pc, plot = T) 
#offset is best model but doesn't fit

#use
mort.dna.pc <- glmmTMB(Mortierella ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))

summary(mort.dna.pc)
knitr::kable(summary(mort.dna.pc)$coefficients, digits = 4)
car::Anova (mort.dna.pc)

#check model
test <- simulateResiduals(fittedModel = mort.dna.pcrand, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(mort.dna.pcrand)

#EMMEANS
ref_grid(mort.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(mort.dna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```




Penicillium
```{r}
#######with glmtmb
data.itsgen.dna.t0.s$Penicillium
hist(data.itsgen.dna.t0.s$Penicillium,nclass = 500)
boxplot(data.itsgen.dna.t0.s$Penicillium ~ data.itsgen.dna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.dna.t0.s$Penicillium)
distplot(data.itsgen.dna.t0.s$Penicillium, type = "poisson") #fits a poisson
distplot(data.itsgen.dna.t0.s$Penicillium, type = "nbinomial")

#Check if readcount is significant
pen.dna.readcount <- glmmTMB(Penicillium ~ log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family = nbinom1(link = "log"))
summary(pen.dna.readcount)
car::Anova(pen.dna.readcount)#0.01618
test <- simulateResiduals(fittedModel = pen.dna.readcount, plot = T, use.u = T)
#readcount is significant but doesn't fit

#Check if block is significant
pen.dna.block <- glmmTMB(Penicillium ~  block2, 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.block)
car::Anova(pen.dna.block)
test <- simulateResiduals(fittedModel = pen.dna.block, plot = T, use.u = T)
#block2 is significant, fits

#Check if block is significant
pen.dna.blockread <- glmmTMB(Penicillium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.blockread)
car::Anova(pen.dna.blockread)
test <- simulateResiduals(fittedModel = pen.dna.blockread, plot = T, use.u = T)
#block2 is significant, readcount is not significant

anova(pen.dna.readcount,pen.dna.block, pen.dna.blockread) #- use block as random

#test for pre crops
pen.dna.null <- glmmTMB(Penicillium ~  1 ,
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
pen.dna.rand <- glmmTMB(Penicillium ~  1 +(1|block2),
                        data = data.itsgen.dna.t0.s , 
                        family = nbinom1(link = "log")) 
pen.dna.pcrand <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.dna.pcrand, plot = T)
#no fit
pen.dna.pc <- glmmTMB(Penicillium ~  pre.crop,
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.dna.pc, plot = T)
#no fit
pen.dna.pcrandoff <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.pcrandoff, plot = T) #doesn't fit

anova(pen.dna.rand, pen.dna.pcrand, pen.dna.pcrandoff,pen.dna.null, pen.dna.readcount,pen.dna.block, pen.dna.blockread,pen.dna.pc)  

test <- simulateResiduals(fittedModel = pen.dna.pcrandoff, plot = T) 
#offset is best model but doesn't fit



#block 2 significant, readcount ns= select model without offset
pen.dna.pcrand <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.dna.t0.s , 
                      family = nbinom1 (link = "log"))
summary(pen.dna.pcrand)
knitr::kable(summary(pen.dna.pcrand)$coefficients, digits = 4)
car::Anova (pen.dna.pcrand)

#check model
test <- simulateResiduals(fittedModel = pen.dna.pcrand, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(pen.dna.pcrand)

#EMMEANS
ref_grid(pen.dna.pcrand)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(pen.dna.pcrand, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


###########################
RNA

```{r}
data.itsgen.rna.t0.s$Arthrobotrys #(12/12)
data.itsgen.rna.t0.s$Dactylella #(NA)
data.itsgen.rna.t0.s$Dactylellina #(NA)
data.itsgen.rna.t0.s$Monacrosporium #(NA)
data.itsgen.rna.t0.s$Orbilia #(NA)
data.itsgen.rna.t0.s$Lecanicillium #(NA)
data.itsgen.rna.t0.s$Trichoderma #(10/12)
data.itsgen.rna.t0.s$Fusarium #(12/12)
data.itsgen.rna.t0.s$Drechmeria #(NA)
data.itsgen.rna.t0.s$Haptocillium #(NA)
data.itsgen.rna.t0.s$Hirsutella #(NA)
data.itsgen.rna.t0.s$Coprinus #(NA)
data.itsgen.rna.t0.s$Coprinellus #(1/12)
data.itsgen.rna.t0.s$Stropharia #(NA)
data.itsgen.rna.t0.s$Paraglomus #(1/12) 
data.itsgen.rna.t0.s$Mortierella #(9/12)
```

Arthrobotrys
```{r}
#######with glmtmb
data.itsgen.rna.t0.s$Arthrobotrys
hist(data.itsgen.rna.t0.s$Arthrobotrys,nclass = 100)
boxplot(data.itsgen.rna.t0.s$Arthrobotrys ~ data.itsgen.rna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.rna.t0.s$Arthrobotrys)
distplot(data.itsgen.rna.t0.s$Arthrobotrys, type = "poisson") #fits a poisson
distplot(data.itsgen.rna.t0.s$Arthrobotrys, type = "nbinomial")

#Check if readcount is significant
arth.rna.readcount <- glmmTMB(Arthrobotrys ~ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family = nbinom1(link = "log"))
summary(arth.rna.readcount)
car::Anova(arth.rna.readcount)#0.01618
test <- simulateResiduals(fittedModel = arth.rna.readcount, plot = T, use.u = T)
#readcount is not significant, fits

#Check if block is significant
arth.rna.block <- glmmTMB(Arthrobotrys ~  block2, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.block)
car::Anova(arth.rna.block)
test <- simulateResiduals(fittedModel = arth.rna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
arth.rna.blockread <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.blockread)
car::Anova(arth.rna.blockread)
test <- simulateResiduals(fittedModel = arth.rna.blockread, plot = T, use.u = T)
#block2 is non-significant, readcount is not significant - but doesn't fit

#Check complete
arth.rna.complete <- glmmTMB(Arthrobotrys ~ pre.crop+ block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.complete)
car::Anova(arth.rna.complete)
test <- simulateResiduals(fittedModel = arth.rna.complete, plot = T, use.u = T)

anova(arth.rna.readcount,arth.rna.block, arth.rna.blockread, arth.rna.complete) #- use block as random

#test for pre crops
arth.rna.null <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
arth.rna.rand <- glmmTMB(Arthrobotrys ~  1 +(1|block2),
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log"))
arth.rna.pc <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.pc, plot = T)
#fits
car::Anova(arth.rna.pc)

arth.rna.pcrand <- glmmTMB(Arthrobotrys ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.pcrand, plot = T)
car::Anova(arth.rna.pcrand)
#fits
#random term shouldn't be included but is the only that fits
arth.rna.pcoff <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.pcoff, plot = T)
#fits
car::Anova(arth.rna.pcoff)
arth.rna.pcrandoff <- glmmTMB(Arthrobotrys ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.pcrandoff, plot = T)
#fits
anova(arth.rna.null,arth.rna.rand, arth.rna.pcrand,arth.rna.pc,arth.rna.pcoff,arth.rna.pcrandoff)

#block 2 significant, readcount ns= select model without offset
arth.rna.pc <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.pc, plot = T)
summary(arth.rna.pc)
knitr::kable(summary(arth.rna.pc)$coefficients, digits = 4)
car::Anova (arth.rna.pcrandoff)

#check model
test <- simulateResiduals(fittedModel = arth.rna.pcrandoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(arth.rna.pcrandoff)

#EMMEANS
ref_grid(arth.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(arth.rna.pcrandoff, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


Fusarium
```{r}
#######with glmtmb
data.itsgen.rna.t0.s$Fusarium
hist(data.itsgen.rna.t0.s$Fusarium,nclass = 500)
boxplot(data.itsgen.rna.t0.s$Fusarium ~ data.itsgen.rna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.rna.t0.s$Fusarium)
distplot(data.itsgen.rna.t0.s$Fusarium, type = "poisson") #fits a poisson
distplot(data.itsgen.rna.t0.s$Fusarium, type = "nbinomial")

#Check if readcount is significant
fus.rna.readcount <- glmmTMB(Fusarium ~ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family = nbinom1(link = "log"))
summary(fus.rna.readcount)
car::Anova(fus.rna.readcount)#0.01618
test <- simulateResiduals(fittedModel = fus.rna.readcount, plot = T, use.u = T)
#readcount is non significant, fits

#Check if block is significant
fus.rna.block <- glmmTMB(Fusarium ~  block2, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.block)
car::Anova(fus.rna.block)
test <- simulateResiduals(fittedModel = fus.rna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
fus.rna.blockread <- glmmTMB(Fusarium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.blockread)
car::Anova(fus.rna.blockread)
test <- simulateResiduals(fittedModel = fus.rna.blockread, plot = T, use.u = T)
#block2 is significant, readcount is significant, doesn't fit

#Check complete
fus.rna.blockreadpc <- glmmTMB(Fusarium ~  pre.crop+block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.blockreadpc)
car::Anova(fus.rna.blockreadpc)
test <- simulateResiduals(fittedModel = fus.rna.blockreadpc, plot = T, use.u = T)
#all significant, fits

anova(fus.rna.readcount,fus.rna.block, fus.rna.blockread,fus.rna.blockreadpc) #- use block as random

#test for pre crops
fus.rna.null <- glmmTMB(Fusarium ~  1 ,
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
fus.rna.rand <- glmmTMB(Fusarium ~  1 +(1|block2),
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
fus.rna.pcrand <- glmmTMB(Fusarium ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.pcrand, plot = T)
#fits
fus.rna.pc <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.pc, plot = T)
#fits
fus.rna.pcrandoff <- glmmTMB(Fusarium ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.pcrandoff, plot = T) #fits
#doesn't fit
fus.rna.pcoff <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.pcoff, plot = T) #fits
#fits
anova(fus.rna.null, fus.rna.rand, fus.rna.pcrand, fus.rna.pcrandoff, fus.rna.readcount,fus.rna.block, fus.rna.blockread,fus.rna.pc,fus.rna.pcoff)  
anova(fus.rna.pcrandoff,fus.rna.pcoff,fus.rna.pc,fus.rna.null )

#block 2 significant, readcount sign = select model rand and offset
fus.rna.pc <- glmmTMB(Fusarium ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.pc, plot = T)
summary(fus.rna.pc)
knitr::kable(summary(fus.rna.pc)$coefficients, digits = 4)
car::Anova (fus.rna.pc)

#check model
test <- simulateResiduals(fittedModel = fus.rna.pc, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(fus.rna.pc)

#EMMEANS
ref_grid(fus.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(fus.rna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Trichoderma
```{r}
#######with glmtmb
data.itsgen.rna.t0.s$Trichoderma
hist(data.itsgen.rna.t0.s$Trichoderma,nclass = 1000)
boxplot(data.itsgen.rna.t0.s$Trichoderma ~ data.itsgen.rna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.rna.t0.s$Trichoderma)
distplot(data.itsgen.rna.t0.s$Trichoderma, type = "poisson") #fits a poisson
distplot(data.itsgen.rna.t0.s$Trichoderma, type = "nbinomial")

#Check if readcount is significant
trich.rna.readcount <- glmmTMB(Trichoderma ~ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family = nbinom1(link = "log"))
summary(trich.rna.readcount)
car::Anova(trich.rna.readcount)#0.01618
test <- simulateResiduals(fittedModel = trich.rna.readcount, plot = T, use.u = T)
#readcount is non-significant and doesn't fit

#Check if block is significant
trich.rna.block <- glmmTMB(Trichoderma ~  block2, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.block)
car::Anova(trich.rna.block)
test <- simulateResiduals(fittedModel = trich.rna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if block is significant
trich.rna.blockread <- glmmTMB(Trichoderma ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.blockread)
car::Anova(trich.rna.blockread)
test <- simulateResiduals(fittedModel = trich.rna.blockread, plot = T, use.u = T)
#block2 is non-significant, readcount is significant - it doesn't fit

#Check complete
trich.rna.complete<- glmmTMB(Trichoderma ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.complete)
car::Anova(trich.rna.complete)
test <- simulateResiduals(fittedModel = trich.rna.complete, plot = T, use.u = T)
#nothing significant, it fits

anova(trich.rna.readcount,trich.rna.block, trich.rna.blockread,trich.rna.complete) #- use without block , with offset

#test for pre crops
trich.rna.nulloff <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot)) 
trich.rna.pc <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.rna.pc, plot = T)
testZeroInflation(test)#no need zero inflation
car::Anova(trich.rna.pc)#sifnificant
trich.rna.pcoff <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.pcoff, plot = T)
#fits
car::Anova(trich.rna.pcoff)
#fits and significant
#random term shouldn't be included but is the only that fits
trich.rna.pcrandoff <- glmmTMB(Trichoderma ~  pre.crop + (1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.pcrandoff, plot = T)
#fits
car::Anova(trich.rna.pcrandoff)
#fits and significant
anova(trich.rna.nulloff,trich.rna.pcoff,trich.rna.pc,trich.rna.pcrandoff) # best just with pc


#use 
trich.rna.pc <- glmmTMB(Trichoderma ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
summary(trich.rna.pc)
knitr::kable(summary(trich.rna.pc)$coefficients, digits = 4)
car::Anova (trich.rna.pc)

#check model
test <- simulateResiduals(fittedModel = trich.rna.pc, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(trich.rna.pc)

#EMMEANS
ref_grid(trich.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(trich.rna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Mortierella
```{r}
#######with glmtmb
data.itsgen.rna.t0.s$Mortierella
hist(data.itsgen.rna.t0.s$Mortierella,nclass = 1000)
boxplot(data.itsgen.rna.t0.s$Mortierella ~ data.itsgen.rna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.rna.t0.s$Mortierella)
distplot(data.itsgen.rna.t0.s$Mortierella, type = "poisson") #fits a poisson
distplot(data.itsgen.rna.t0.s$Mortierella, type = "nbinomial")

#Check if readcount is significant
mort.rna.readcount <- glmmTMB(Mortierella ~ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family = nbinom1(link = "log"))
summary(mort.rna.readcount)
car::Anova(mort.rna.readcount)
test <- simulateResiduals(fittedModel = mort.rna.readcount, plot = T, use.u = T)
#readcount is not significant, doesn't fit

#Check if block is significant
mort.rna.block <- glmmTMB(Mortierella ~  block2, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.block)
car::Anova(mort.rna.block)
test <- simulateResiduals(fittedModel = mort.rna.block, plot = T, use.u = T)
#block2 is not significant, fits

#Check if block + read is significant
mort.rna.blockread <- glmmTMB(Mortierella ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.blockread)
car::Anova(mort.rna.blockread)
test <- simulateResiduals(fittedModel = mort.rna.blockread, plot = T, use.u = T)
#both significant, no fit

#Check if block + read  pre crop is significant
mort.rna.blockreadpc <- glmmTMB(Mortierella ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.blockreadpc)
car::Anova(mort.rna.blockreadpc)
test <- simulateResiduals(fittedModel = mort.rna.blockreadpc, plot = T, use.u = T)
#block and readcount is significant, no fit

#Check if block + read  pre crop is significant
mort.rna.blockpc <- glmmTMB(Mortierella ~  block2 +pre.crop, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.blockpc)
car::Anova(mort.rna.blockpc)
test <- simulateResiduals(fittedModel = mort.rna.blockpc, plot = T, use.u = T)
#no significant - fits

#Check complete
mort.rna.complete <- glmmTMB(Mortierella ~  block2 +pre.crop+ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.complete)
car::Anova(mort.rna.complete)
test <- simulateResiduals(fittedModel = mort.rna.complete, plot = T, use.u = T)
#block-read significant - no fit

anova(mort.rna.readcount,mort.rna.block, mort.rna.blockread, mort.rna.blockpc,mort.rna.blockreadpc,mort.rna.null) #- use block as random

#test for pre crops
mort.rna.null <- glmmTMB(Mortierella ~  1 ,
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
mort.rna.rand <- glmmTMB(Mortierella ~  1 +(1|block2),
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
mort.rna.pcrand <- glmmTMB(Mortierella ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.rna.pcrand, plot = T)#fits
testZeroInflation(test)#no zero inflation
mort.rna.pcrandoff <- glmmTMB(Mortierella ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
car::Anova(mort.rna.pcrandoff)
test <- simulateResiduals(fittedModel = mort.rna.pcrandoff, plot = T) #doesn''t fit
mort.rna.pc <- glmmTMB(Mortierella ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.rna.pc, plot = T) #doesn''t fit
mort.rna.pcoff <- glmmTMB(Mortierella ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
anova(mort.rna.rand, mort.rna.pcrand, mort.rna.pcrandoff, mort.rna.pc, mort.rna.null,mort.rna.pcoff) 
test <- simulateResiduals(fittedModel = mort.rna.pcoff, plot = T) 
#pcoff fits

#use
mort.rna.pcrandoff <- glmmTMB(Mortierella ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
summary(mort.rna.pcrandoff)
knitr::kable(summary(mort.rna.pcrandoff)$coefficients, digits = 4)
car::Anova (mort.rna.pcrandoff)

#check model
test <- simulateResiduals(fittedModel = mort.rna.pcrand, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(mort.rna.pcrand)

#EMMEANS
ref_grid(mort.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(mort.rna.pcrandoff, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```




Penicillium
```{r}
#######with glmtmb
data.itsgen.rna.t0.s$Penicillium
hist(data.itsgen.rna.t0.s$Penicillium,nclass = 500)
boxplot(data.itsgen.rna.t0.s$Penicillium ~ data.itsgen.rna.t0.s$pre.crop)
#normal?
shapiro.test(data.itsgen.rna.t0.s$Penicillium)
distplot(data.itsgen.rna.t0.s$Penicillium, type = "poisson") #fits a poisson
distplot(data.itsgen.rna.t0.s$Penicillium, type = "nbinomial")

#Check if readcount is significant
pen.rna.readcount <- glmmTMB(Penicillium ~ log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family = nbinom1(link = "log"))
summary(pen.rna.readcount)
car::Anova(pen.rna.readcount)#0.01618
test <- simulateResiduals(fittedModel = pen.rna.readcount, plot = T, use.u = T)
#readcount is significant but doesn't fit

#Check if block is significant
pen.rna.block <- glmmTMB(Penicillium ~  block2, 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.block)
car::Anova(pen.rna.block)
test <- simulateResiduals(fittedModel = pen.rna.block, plot = T, use.u = T)
#block2 is significant, fits

#Check if block is significant
pen.rna.blockread <- glmmTMB(Penicillium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t0.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.blockread)
car::Anova(pen.rna.blockread)
test <- simulateResiduals(fittedModel = pen.rna.blockread, plot = T, use.u = T)
#block2 is significant, readcount is not significant

anova(pen.rna.readcount,pen.rna.block, pen.rna.blockread) #- use block as random

#test for pre crops
pen.rna.null <- glmmTMB(Penicillium ~  1 ,
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
pen.rna.rand <- glmmTMB(Penicillium ~  1 +(1|block2),
                        data = data.itsgen.rna.t0.s , 
                        family = nbinom1(link = "log")) 
pen.rna.pcrand <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.rna.pcrand, plot = T)
#no fit
pen.rna.pc <- glmmTMB(Penicillium ~  pre.crop,
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.rna.pc, plot = T)
#no fit
pen.rna.pcrandoff <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.pcrandoff, plot = T) #doesn't fit

anova(pen.rna.rand, pen.rna.pcrand, pen.rna.pcrandoff,pen.rna.null, pen.rna.readcount,pen.rna.block, pen.rna.blockread,pen.rna.pc)  

test <- simulateResiduals(fittedModel = pen.rna.pcrandoff, plot = T) 
#offset is best model but doesn't fit



#block 2 significant, readcount ns= select model without offset
pen.rna.pcrand <- glmmTMB(Penicillium ~  pre.crop+(1|block2),
                      data = data.itsgen.rna.t0.s , 
                      family = nbinom1 (link = "log"))
summary(pen.rna.pcrand)
knitr::kable(summary(pen.rna.pcrand)$coefficients, digits = 4)
car::Anova (pen.rna.pcrand)

#check model
test <- simulateResiduals(fittedModel = pen.rna.pcrand, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(pen.rna.pcrand)

#EMMEANS
ref_grid(pen.rna.pcrand)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(pen.rna.pcrand, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```




################################################################################################################################################################################################################################################################################
t1

```{r}
load (file = 'ps-selected-only-ITS-filt-lowabd-no-neg-norep.RData')
ps.ITS.dna.t1 <- subset_samples(ps.ITS, nucleic.acid == "DNA" & time.point == "T1")
ps.ITS.rna.t1 <- subset_samples(ps.ITS, nucleic.acid == "RNA" & time.point == "T1")
ps.ITS.dna.t1@sam_data$readcount.tot <- readcount(ps.ITS.dna.t1)
ps.ITS.rna.t1@sam_data$readcount.tot <- readcount(ps.ITS.rna.t1)

ant.ITS.dna.t1.gen <- subset_taxa(ps.ITS.dna.t1, Genus %in% c("Orbilia", "Arthrobotrys", "Dactylella", "Dactylellina",
                                                                      "Drechmeria","Haptocillium", "Hirsutella", "Lecanicillium", 
                                                                      "Trichoderma", "Fusarium", "Penicillium", "Nematoctonus", 
                                                                      "Coprinus", "Coprinellus", "Stropharia", "Glomus", "Paraglomus", 
                                                                      "Mortierella", "Monacrosporium"))
ant.ITS.rna.t1.gen <- subset_taxa(ps.ITS.rna.t1, Genus %in% c("Orbilia", "Arthrobotrys", "Dactylella", "Dactylellina",
                                                                      "Drechmeria","Haptocillium", "Hirsutella", "Lecanicillium", 
                                                                      "Trichoderma", "Fusarium", "Penicillium", "Nematoctonus", 
                                                                      "Coprinus", "Coprinellus", "Stropharia", "Glomus", "Paraglomus", 
                                                                      "Mortierella", "Monacrosporium"))
ant.ITS.dna.t1.gen = prune_taxa(taxa_sums(ant.ITS.dna.t1.gen) > 0, ant.ITS.dna.t1.gen)
ant.ITS.dna.t1.gen

ant.ITS.rna.t1.gen = prune_taxa(taxa_sums(ant.ITS.rna.t1.gen) > 0, ant.ITS.rna.t1.gen)
ant.ITS.rna.t1.gen

ant.ITS.dna.t1.gen@sam_data$pre.crop <- fct_relevel(ant.ITS.dna.t1.gen@sam_data$pre.crop, "bo", "ry", "ir", "er")
ant.ITS.dna.t1.gen@sam_data$cc <- fct_relevel(ant.ITS.dna.t1.gen@sam_data$cc, "FW", "OSR_T", "OSR_A", "OSR_R","PHA", "VE", "BO","BO.OSR_R", "BO.OSR_T", "PHA.OSR_T", "VE.OSR_T")
                                    
ant.ITS.rna.t1.gen@sam_data$pre.crop <- fct_relevel(ant.ITS.rna.t1.gen@sam_data$pre.crop, "bo", "ry", "ir", "er")
ant.ITS.rna.t1.gen@sam_data$cc <- fct_relevel(ant.ITS.rna.t1.gen@sam_data$cc, "FW", "OSR_T", "OSR_A", "OSR_R","PHA", "VE", "BO","BO.OSR_R", "BO.OSR_T", "PHA.OSR_T", "VE.OSR_T")

#DNA
ant.itsgen.dna.t1.s <- microbiome::aggregate_taxa(ant.ITS.dna.t1.gen, "Genus")
samdf.itsgen.dna.t1.s <-as.data.frame(sample_data (ant.itsgen.dna.t1.s))
otu.itsgen.dna.t1.s <- as.data.frame (t(otu_table(ant.itsgen.dna.t1.s)))
tax.itsgen.dna.t1.s <- as.data.frame(tax_table(ant.itsgen.dna.t1.s))

data.itsgen.dna.t1.s <- merge (samdf.itsgen.dna.t1.s, otu.itsgen.dna.t1.s,  by = 'row.names')
colnames(data.itsgen.dna.t1.s)

data.itsgen.dna.t1.s$pre.crop <- as.factor(data.itsgen.dna.t1.s$pre.crop)
data.itsgen.dna.t1.s$pre.crop <- fct_relevel(data.itsgen.dna.t1.s$pre.crop, "er", "ir", "ry", "bo")

ITS.antagonists.T1.dna <- colnames(otu.itsgen.dna.t1.s)
#add readcount
data.itsgen.dna.t1.s$readcount <- rowSums(otu.itsgen.dna.t1.s[1:14])

#RNA
ant.itsgen.rna.t1.s <- microbiome::aggregate_taxa(ant.ITS.rna.t1.gen, "Genus")
samdf.itsgen.rna.t1.s <-as.data.frame(sample_data (ant.itsgen.rna.t1.s))
otu.itsgen.rna.t1.s <- as.data.frame (t(otu_table(ant.itsgen.rna.t1.s)))
tax.itsgen.rna.t1.s <- as.data.frame(tax_table(ant.itsgen.rna.t1.s))

data.itsgen.rna.t1.s <- merge (samdf.itsgen.rna.t1.s, otu.itsgen.rna.t1.s,  by = 'row.names')
colnames(data.itsgen.rna.t1.s)

ITS.antagonists.T1.rna <- colnames(otu.itsgen.rna.t1.s)
 
colnames(data.itsgen.rna.t1.s)
data.itsgen.rna.t1.s$pre.crop <- as.factor(data.itsgen.rna.t1.s$pre.crop)
data.itsgen.rna.t1.s$pre.crop <- fct_relevel(data.itsgen.rna.t1.s$pre.crop, "er", "ir", "ry", "bo")
#add readcount
data.itsgen.rna.t1.s$readcount <- rowSums(otu.itsgen.rna.t1.s[1:15])
```


#plots
```{r}
data.itsgen.dna.t1.s.long <- data.itsgen.dna.t1.s %>%
  dplyr::select(cc, pre.crop, readcount.tot, Arthrobotrys, Fusarium, Mortierella,Trichoderma) %>% 
  tidyr::pivot_longer(cols = Arthrobotrys:Trichoderma, 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
              mutate (Rel.abundance.DNA = (Abundance/readcount.tot)) 
data.itsgen.dna.t1.s.long$pre.crop <- forcats::fct_relevel(data.itsgen.dna.t1.s.long$pre.crop, "bo", "ry", "ir", "er" )
  
data.itsgen.rna.t1.s.long <- data.itsgen.rna.t1.s %>% 
  dplyr::select(cc, pre.crop,readcount.tot,Arthrobotrys, Fusarium, Mortierella,Trichoderma) %>% 
  tidyr::pivot_longer(cols = Arthrobotrys:Trichoderma, 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
  mutate (Rel.abundance.RNA = (Abundance/readcount.tot)) 
data.itsgen.rna.t1.s.long$pre.crop <- forcats::fct_relevel(data.itsgen.rna.t1.s.long$pre.crop, "bo", "ry", "ir", "er" )

#horizontal 
colorCode2 <- c(BO = "#490092", BO.OSR_R = "#b66dff", BO.OSR_T = "#ffb6db",  FW = "grey50", OSR_A = "#6db6ff", OSR_R = "#006ddb", OSR_T = "#b6dbff", PHA = "#009292", PHA.OSR_T = "#004949", VE = "#db6d00", VE.OSR_T = "#924900")

plot.ant.its.dna.t1h<- data.itsgen.dna.t1.s.long %>%  
                        ggplot (mapping = aes(y=Rel.abundance.DNA, x =cc, fill = cc))+
                        geom_boxplot(orientation = "x", fatten = 1)+
                        #geom_point(alpha = 0.5)+
                        scale_y_continuous(limits = c(0,0.10), labels = scales::percent)+
                        scale_fill_manual(values = colorCode2)+
                        labs(title = "Relative abundance of antagonistic fungal genera in DNA", y = "Relative abundance")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow = 1)+
   theme_classic()+
  theme(axis.line.y.left = (element_blank()), 
        axis.text.x = (element_text(angle = 90, size = 8, hjust = 1)),
        strip.text.x = element_text(size = 8))
plot.ant.its.dna.t1h

plot.ant.its.rna.t1h<- data.itsgen.rna.t1.s.long %>%  
                        ggplot (mapping = aes(y=Rel.abundance.RNA, x =cc, fill = cc))+
                        geom_boxplot(orientation = "x", fatten = 1)+
                        #geom_point(alpha = 0.5)+
                        scale_y_continuous(limits = c(0,0.10), labels = scales::percent)+
                        #scale_color_manual(values = colorCode2)+
                        scale_fill_manual(values = colorCode2)+
                        labs(title = "Relative abundance of antagonistic fungal genera in RNA", y = "Relative abundance ")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow = 1)+
   theme_classic()+
  theme(axis.line.y.left = (element_blank()), 
        axis.text.x = (element_text(angle = 90, size = 8, hjust = 1)),
        strip.text.x = element_text(size = 8))
plot.ant.its.rna.t1h

library(cowplot)
#ant.t0 <- plot_grid(plot.ant.bact.dna.t0h, 
#                    plot.ant.bact.rna.t0h,
#                    align = "hv",
#                    ncol = 1)
#ant.t0 

```


```{r}
library(cowplot)
ant.t1.double.dnaf <- plot_grid( plot.comp.dna.f,
                            plot.ant.its.dna.t1h,
                            align = "hv",
                            ncol = 2,
                            rel_widths = c(0.5,1),
                            scale = 1)
ant.t1.double.dnaf

ant.t1.double.rnaf <- plot_grid( plot.comp.rna.f,
                            plot.ant.its.rna.t1h,
                            align = "hv",
                            ncol = 2,
                            rel_widths = c(0.5,1),
                            scale = 1)
ant.t1.double.rnaf

ant.t1.fourf <- plot_grid(ant.t1.double.dnaf,
                         ant.t1.double.rnaf,
                         align = "hv",
                         nrow = 2,
                         rel_widths = c(0.4,1),
                          scale = 1)
ant.t1.fourf
```
 


```{r}
length(which(data.itsgen.dna.t1.s$Arthrobotrys > 0))#(126/130)
length(which(data.itsgen.dna.t1.s$Dactylella> 0)) #(1/130)
length(which(data.itsgen.dna.t1.s$Monacrosporium> 0)) #(18/130)
length(which(data.itsgen.dna.t1.s$Orbilia > 0))#(3/130)
length(which(data.itsgen.dna.t1.s$Trichoderma > 0))#(124/130)
length(which(data.itsgen.dna.t1.s$Fusarium> 0)) #(130/130)
length(which(data.itsgen.dna.t1.s$Drechmeria > 0))#(1/130)
length(which(data.itsgen.dna.t1.s$Haptocillium > 0))#(30/130)
length(which(data.itsgen.dna.t1.s$Hirsutella> 0)) #(46/130)
length(which(data.itsgen.dna.t1.s$Coprinus> 0)) #(1/130)
length(which(data.itsgen.dna.t1.s$Coprinellus > 0))#(16/130)
length(which(data.itsgen.dna.t1.s$Mortierella > 0))#(116/130)
length(which(data.itsgen.dna.t1.s$Penicillium > 0))#(130/130)
length(which(data.itsgen.dna.t1.s$Nematoctonus > 0))#(34/130)
```


Arthrobotrys
```{r}
data.itsgen.dna.t1.s$Arthrobotrys
hist(data.itsgen.dna.t1.s$Arthrobotrys,nclass = 100)
boxplot(data.itsgen.dna.t1.s$Arthrobotrys ~ data.itsgen.dna.t1.s$pre.crop)

#Check if readcount is significant
arth.dna.readcount <- glmmTMB(Arthrobotrys ~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(arth.dna.readcount)
car::Anova(arth.dna.readcount)
test <- simulateResiduals(fittedModel = arth.dna.readcount, plot = T, use.u = T)
#readcount is significant but doesn't fit

#Check if block is significant
arth.dna.block <- glmmTMB(Arthrobotrys ~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.block)
car::Anova(arth.dna.block)
test <- simulateResiduals(fittedModel = arth.dna.block, plot = T, use.u = T)
#block2 is non-significant, doesn't fit

#Check if pre crop
arth.dna.pc <- glmmTMB(Arthrobotrys ~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.pc)
car::Anova(arth.dna.pc)
test <- simulateResiduals(fittedModel = arth.dna.pc, plot = T, use.u = T)
#pre crop is non-significant, doesn't fit

#Check if block + read is significant
arth.dna.blockread <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.blockread)
car::Anova(arth.dna.blockread)
test <- simulateResiduals(fittedModel = arth.dna.blockread, plot = T, use.u = T)
#readcount is the only significant - but doesn't fit

#Check if pre crop + read is significant
arth.dna.pcread <- glmmTMB(Arthrobotrys ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.pcread)
car::Anova(arth.dna.pcread)
test <- simulateResiduals(fittedModel = arth.dna.pcread, plot = T, use.u = T)
#readcount is the only significant - but doesn't fit

#Check if block is significant
arth.dna.blockreadpc <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.blockreadpc)
car::Anova(arth.dna.blockreadpc)
test <- simulateResiduals(fittedModel = arth.dna.blockreadpc, plot = T, use.u = T)
#readcount is the only significant - but doesn't fit

#Check complete
arth.dna.complete <- glmmTMB(Arthrobotrys ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.dna.complete)
car::Anova(arth.dna.complete)
test <- simulateResiduals(fittedModel = arth.dna.complete, plot = T, use.u = T)

anova(arth.dna.readcount,arth.dna.block, arth.dna.blockread, arth.dna.blockreadpc, arth.dna.complete,arth.dna.pcread ) #- use block as random

#test for pre crops
arth.dna.null <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
arth.dna.null.off <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.null.off, plot = T)#no fit
arth.dna.cc <- glmmTMB(Arthrobotrys ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.dna.cc, plot = T)#no fit
arth.dna.ccrand <- glmmTMB(Arthrobotrys ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.dna.ccrand, plot = T)#no fit
arth.dna.ccrandpc <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.dna.ccrandpc, plot = T)#no fit
car::Anova(arth.dna.ccrand)
arth.dna.ccrandoff <- glmmTMB(Arthrobotrys ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.ccrandoff, plot = T)#no fit
car::Anova(arth.dna.ccrandoff)
arth.dna.ccoff <- glmmTMB(Arthrobotrys ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.ccoff, plot = T)#no fit but best model
car::Anova(arth.dna.ccoff)
arth.dna.ccpcoff <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.ccpcoff, plot = T)#no fit
car::Anova(arth.dna.ccpcoff)
arth.dna.ccpcbloff <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.ccpcbloff, plot = T)#no fit
car::Anova(arth.dna.ccpcbloff)

#anova
anova(arth.dna.null,arth.dna.cc,arth.dna.ccrand, arth.dna.ccrandpc)
anova(arth.dna.null.off, arth.dna.ccrandoff,arth.dna.ccoff,arth.dna.ccpcoff,arth.dna.ccpcbloff)
#choose best model - cc + offset - none ofthe model its

arth.dna.ccoff <- glmmTMB(Arthrobotrys ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.dna.ccoff, plot = T)#no fit
car::Anova(arth.dna.ccoff)
summary(arth.dna.ccoff)
knitr::kable(summary(arth.dna.ccoff)$coefficients, digits = 4)

#check model
test <- simulateResiduals(fittedModel = arth.dna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(arth.dna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(arth.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(arth.dna.ccoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Trichoderma
```{r}
data.itsgen.dna.t1.s$Trichoderma
hist(data.itsgen.dna.t1.s$Trichoderma,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Trichoderma ~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Trichoderma ~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Trichoderma ~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
trich.dna.readcount <- glmmTMB(Trichoderma ~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(trich.dna.readcount)
car::Anova(trich.dna.readcount)
test <- simulateResiduals(fittedModel = trich.dna.readcount, plot = T, use.u = T)
#readcount is significant and it fits

#Check if block is significant
trich.dna.block <- glmmTMB(Trichoderma ~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.block)
car::Anova(trich.dna.block)
test <- simulateResiduals(fittedModel = trich.dna.block, plot = T, use.u = T)
#block2 is non-significant, doesn't fit

#Check if pre crop
trich.dna.pc <- glmmTMB(Trichoderma ~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.pc)
car::Anova(trich.dna.pc)
test <- simulateResiduals(fittedModel = trich.dna.pc, plot = T, use.u = T)
#pre crop is non-significant, fits

#Check if block + read is significant
trich.dna.blockread <- glmmTMB(Trichoderma ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.blockread)
car::Anova(trich.dna.blockread)
test <- simulateResiduals(fittedModel = trich.dna.blockread, plot = T, use.u = T)
#readcount and block significant, fits

#Check if pre crop + read is significant
trich.dna.pcread <- glmmTMB(Trichoderma ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.pcread)
car::Anova(trich.dna.pcread)
test <- simulateResiduals(fittedModel = trich.dna.pcread, plot = T, use.u = T)
#readcount is the only significant - fits


#Check complete
trich.dna.complete <- glmmTMB(Trichoderma ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.dna.complete)
car::Anova(trich.dna.complete)
test <- simulateResiduals(fittedModel = trich.dna.complete, plot = T, use.u = T)
#block, pre crop and cc are significant but doesn't fit

anova(trich.dna.readcount,trich.dna.block, trich.dna.blockread, trich.dna.blockreadpc, trich.dna.complete,trich.dna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
trich.dna.null <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
trich.dna.null.off <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.null.off, plot = T)#no fit
trich.dna.cc <- glmmTMB(Trichoderma ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.dna.cc, plot = T)#no fit
car::Anova(trich.dna.cc)
trich.dna.ccrand <- glmmTMB(Trichoderma ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.dna.ccrand, plot = T)#no fit
trich.dna.ccrandpc <- glmmTMB(Trichoderma ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.dna.ccrandpc, plot = T)#no fit
car::Anova(trich.dna.ccrand)
trich.dna.ccrandoff <- glmmTMB(Trichoderma ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.ccrandoff, plot = T)#no fit
testZeroInflation(test)
car::Anova(trich.dna.ccrandoff)
trich.dna.ccoff <- glmmTMB(Trichoderma ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.ccoff, plot = T)#no fit but best model
car::Anova(trich.dna.ccoff)
trich.dna.ccpcoff <- glmmTMB(Trichoderma ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.ccpcoff, plot = T)#no fit
car::Anova(trich.dna.ccpcoff)
trich.dna.ccpcbloff <- glmmTMB(Trichoderma ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.ccpcbloff, plot = T)#no fit
car::Anova(trich.dna.ccpcbloff)

#anova
anova(trich.dna.null,trich.dna.cc,trich.dna.ccrand, trich.dna.ccrandpc)
anova(trich.dna.null.off, trich.dna.ccrandoff,trich.dna.ccoff,trich.dna.ccpcoff,trich.dna.ccpcbloff)
#choose best model - cc + offset + random - none ofthe model its

trich.dna.ccrandoff <- glmmTMB(Trichoderma ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.dna.ccrandoff, plot = T)#no fit
car::Anova(trich.dna.ccrandoff)
summary(trich.dna.ccrandoff)

#check model
test <- simulateResiduals(fittedModel = trich.dna.ccrandoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(trich.dna.ccrandoff)
testZeroInflation(test)

#EMMEANS
ref_grid(trich.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(trich.dna.ccrandoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Penicillium
```{r}
data.itsgen.dna.t1.s$Penicillium
hist(data.itsgen.dna.t1.s$Penicillium,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Penicillium ~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Penicillium ~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Penicillium ~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
pen.dna.readcount <- glmmTMB(Penicillium ~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(pen.dna.readcount)
car::Anova(pen.dna.readcount)
test <- simulateResiduals(fittedModel = pen.dna.readcount, plot = T, use.u = T)
#readcount is significant - no fit

#Check if block is significant
pen.dna.block <- glmmTMB(Penicillium ~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.block)
car::Anova(pen.dna.block)
test <- simulateResiduals(fittedModel = pen.dna.block, plot = T, use.u = T)
#block2 is non-significant, doesn't fit

#Check if pre crop
pen.dna.pc <- glmmTMB(Penicillium ~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.pc)
car::Anova(pen.dna.pc)
test <- simulateResiduals(fittedModel = pen.dna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
pen.dna.blockread <- glmmTMB(Penicillium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.blockread)
car::Anova(pen.dna.blockread)
test <- simulateResiduals(fittedModel = pen.dna.blockread, plot = T, use.u = T)
#readcount significant, no fit

#Check if pre crop + read is significant
pen.dna.pcread <- glmmTMB(Penicillium ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.pcread)
car::Anova(pen.dna.pcread)
test <- simulateResiduals(fittedModel = pen.dna.pcread, plot = T, use.u = T)
#readcount is the only significant - - no fit


#Check complete
pen.dna.complete <- glmmTMB(Penicillium ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.dna.complete)
car::Anova(pen.dna.complete)
test <- simulateResiduals(fittedModel = pen.dna.complete, plot = T, use.u = T)
#block, readcount  and cc are significant but doesn't fit

anova(pen.dna.readcount,pen.dna.block, pen.dna.blockread, pen.dna.blockreadpc, pen.dna.complete,pen.dna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
pen.dna.null <- glmmTMB(Penicillium ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
pen.dna.null.off <- glmmTMB(Penicillium ~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.null.off, plot = T)#no fit
pen.dna.cc <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.dna.cc, plot = T)#no fit
pen.dna.ccrand <- glmmTMB(Penicillium ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.dna.ccrand, plot = T)#no fit
pen.dna.ccrandpc <- glmmTMB(Penicillium ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.dna.ccrandpc, plot = T)#no fit
car::Anova(pen.dna.ccrand)
pen.dna.ccrandoff <- glmmTMB(Penicillium ~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.ccrandoff, plot = T)#no fit
testZeroInflation(test)
car::Anova(pen.dna.ccrandoff)
pen.dna.ccoff <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.ccoff, plot = T)#no fit but best model
car::Anova(pen.dna.ccoff)
pen.dna.ccpcoff <- glmmTMB(Penicillium ~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.ccpcoff, plot = T)#no fit
car::Anova(pen.dna.ccpcoff)
pen.dna.ccpcbloff <- glmmTMB(Penicillium ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.ccpcbloff, plot = T)#no fit
car::Anova(pen.dna.ccpcbloff)

#anova
anova(pen.dna.null,pen.dna.cc,pen.dna.ccrand, pen.dna.ccrandpc)
anova(pen.dna.null.off, pen.dna.ccrandoff,pen.dna.ccoff,pen.dna.ccpcoff,pen.dna.ccpcbloff)
#choose best model - cc + offset + random - none ofthe model its

pen.dna.ccoff <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.dna.ccoff, plot = T)#no fit
car::Anova(pen.dna.ccoff)
knitr::kable(summary(pen.dna.ccoff)$coefficients, digits = 4)
summary(pen.dna.ccoff)

#check model
test <- simulateResiduals(fittedModel = pen.dna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(pen.dna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(pen.dna.ccoff)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(pen.dna.ccrandoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Fusarium
```{r}
data.itsgen.dna.t1.s$Fusarium
hist(data.itsgen.dna.t1.s$Fusarium,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Fusarium~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Fusarium~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Fusarium~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
fus.dna.readcount <- glmmTMB(Fusarium~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(fus.dna.readcount)
car::Anova(fus.dna.readcount)
test <- simulateResiduals(fittedModel = fus.dna.readcount, plot = T, use.u = T)
#readcount is significant but no fit

#Check if block is significant
fus.dna.block <- glmmTMB(Fusarium~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.block)
car::Anova(fus.dna.block)
test <- simulateResiduals(fittedModel = fus.dna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if pre crop
fus.dna.pc <- glmmTMB(Fusarium~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.pc)
car::Anova(fus.dna.pc)
test <- simulateResiduals(fittedModel = fus.dna.pc, plot = T, use.u = T)
#pre crop is non-significant, fits

#Check if block + read is significant
fus.dna.blockread <- glmmTMB(Fusarium~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.blockread)
car::Anova(fus.dna.blockread)
test <- simulateResiduals(fittedModel = fus.dna.blockread, plot = T, use.u = T)
#readcount and block significant, fits

#Check if pre crop + read is significant
fus.dna.pcread <- glmmTMB(Fusarium~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.pcread)
car::Anova(fus.dna.pcread)
test <- simulateResiduals(fittedModel = fus.dna.pcread, plot = T, use.u = T)
#readcount is the only significant - fits


#Check complete
fus.dna.complete <- glmmTMB(Fusarium~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.dna.complete)
car::Anova(fus.dna.complete)
test <- simulateResiduals(fittedModel = fus.dna.complete, plot = T, use.u = T)
#all significant, fits

anova(fus.dna.readcount,fus.dna.block, fus.dna.blockread, fus.dna.complete,fus.dna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
fus.dna.null <- glmmTMB(Fusarium~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
fus.dna.null.off <- glmmTMB(Fusarium~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.null.off, plot = T)#no fit
fus.dna.cc <- glmmTMB(Fusarium~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.cc, plot = T)#fits
fus.dna.ccrand <- glmmTMB(Fusarium~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.ccrand, plot = T)#fits
fus.dna.ccrandpc <- glmmTMB(Fusarium~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.dna.ccrandpc, plot = T)#no fit
car::Anova(fus.dna.ccrand)
fus.dna.ccrandoff <- glmmTMB(Fusarium~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.ccrandoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(fus.dna.ccrandoff)
fus.dna.ccoff <- glmmTMB(Fusarium~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.ccoff, plot = T)#no fit 
car::Anova(fus.dna.ccoff)
fus.dna.ccpcoff <- glmmTMB(Fusarium~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.ccpcoff, plot = T)#no fit
car::Anova(fus.dna.ccpcoff)
fus.dna.ccpcbloff <- glmmTMB(Fusarium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.ccpcbloff, plot = T)#no fit
car::Anova(fus.dna.ccpcbloff)

#anova
anova(fus.dna.null,fus.dna.cc,fus.dna.ccrand, fus.dna.ccrandpc)
anova(fus.dna.null.off, fus.dna.ccrandoff,fus.dna.ccoff,fus.dna.ccpcoff,fus.dna.ccpcbloff)


#choose best model - cc + offset + random - none ofthe model its

fus.dna.ccrandoff <- glmmTMB(Fusarium~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.dna.ccrandoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(fus.dna.ccrandoff)
summary(fus.dna.ccrandoff)
summary(fus.dna.cc)

#check model
test <- simulateResiduals(fittedModel = fus.dna.ccrandoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(fus.dna.ccrandoff)
testZeroInflation(test)

#EMMEANS
ref_grid(fus.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(fus.dna.ccrandoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Mortierella
```{r}
data.itsgen.dna.t1.s$Mortierella
hist(data.itsgen.dna.t1.s$Mortierella,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Mortierella~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Mortierella~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Mortierella~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
mort.dna.readcount <- glmmTMB(Mortierella~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(mort.dna.readcount)
car::Anova(mort.dna.readcount)
test <- simulateResiduals(fittedModel = mort.dna.readcount, plot = T, use.u = T)
#readcount is significant but no fit

#Check if block is significant
mort.dna.block <- glmmTMB(Mortierella~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.block)
car::Anova(mort.dna.block)
test <- simulateResiduals(fittedModel = mort.dna.block, plot = T, use.u = T)
#block2 is non-significant, no fit

#Check if pre crop
mort.dna.pc <- glmmTMB(Mortierella~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.pc)
car::Anova(mort.dna.pc)
test <- simulateResiduals(fittedModel = mort.dna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
mort.dna.blockread <- glmmTMB(Mortierella~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.blockread)
car::Anova(mort.dna.blockread)
test <- simulateResiduals(fittedModel = mort.dna.blockread, plot = T, use.u = T)
#readcount  significant, no fit

#Check if pre crop + read is significant
mort.dna.pcread <- glmmTMB(Mortierella~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.pcread)
car::Anova(mort.dna.pcread)
test <- simulateResiduals(fittedModel = mort.dna.pcread, plot = T, use.u = T)
#readcount is the only significant - no fit


#Check complete
mort.dna.complete <- glmmTMB(Mortierella~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.dna.complete)
car::Anova(mort.dna.complete)
test <- simulateResiduals(fittedModel = mort.dna.complete, plot = T, use.u = T)
#all significant, fits
testZeroInflation(test)#no need

anova(mort.dna.readcount,mort.dna.block, mort.dna.blockread, mort.dna.complete,mort.dna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
mort.dna.null <- glmmTMB(Mortierella~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
mort.dna.null.off <- glmmTMB(Mortierella~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.null.off, plot = T)#no fit
mort.dna.cc <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.dna.cc, plot = T)#no fit
mort.dna.ccrand <- glmmTMB(Mortierella~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.dna.ccrand, plot = T)#no fit
mort.dna.ccrandpc <- glmmTMB(Mortierella~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.dna.ccrandpc, plot = T)#no fit
car::Anova(mort.dna.ccrand)
mort.dna.ccrandoff <- glmmTMB(Mortierella~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.ccrandoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(mort.dna.ccrandoff)
mort.dna.ccoff <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.ccoff, plot = T)#no fit but best model
car::Anova(mort.dna.ccoff)
mort.dna.ccpcoff <- glmmTMB(Mortierella~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.ccpcoff, plot = T)#no fit
car::Anova(mort.dna.ccpcoff)
mort.dna.ccpcbloff <- glmmTMB(Mortierella~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.ccpcbloff, plot = T)#no fit
car::Anova(mort.dna.ccpcbloff)

#anova
anova(mort.dna.null,mort.dna.cc,mort.dna.ccrand, mort.dna.ccrandpc)
anova(mort.dna.null.off, mort.dna.ccrandoff,mort.dna.ccoff,mort.dna.ccpcoff,mort.dna.ccpcbloff)


#choose best model - cc + offset + random - none ofthe model its

mort.dna.ccoff <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.dna.ccoff, plot = T)#no fit but best model
testZeroInflation(test)
testZeroInflation(test)
car::Anova(mort.dna.ccoff)
summary(mort.dna.ccoff)
knitr::kable(summary(mort.dna.ccoff)$coefficients, digits = 4)

#check model
test <- simulateResiduals(fittedModel = mort.dna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(mort.dna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(mort.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(mort.dna.ccoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Hirsutella
```{r}
data.itsgen.dna.t1.s$Hirsutella
hist(data.itsgen.dna.t1.s$Hirsutella,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Hirsutella~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Hirsutella~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Hirsutella~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
hirst.dna.readcount <- glmmTMB(Hirsutella~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(hirst.dna.readcount)
car::Anova(hirst.dna.readcount)
test <- simulateResiduals(fittedModel = hirst.dna.readcount, plot = T, use.u = T)
#readcount is non-significant, fits

#Check if block is significant
hirst.dna.block <- glmmTMB(Hirsutella~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.block)
car::Anova(hirst.dna.block)
test <- simulateResiduals(fittedModel = hirst.dna.block, plot = T, use.u = T)
#block2 is significant,fit

#Check if pre crop
hirst.dna.pc <- glmmTMB(Hirsutella~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.pc)
car::Anova(hirst.dna.pc)
test <- simulateResiduals(fittedModel = hirst.dna.pc, plot = T, use.u = T)
#pre crop is significant, fits

#Check if block + read is significant
hirst.dna.blockread <- glmmTMB(Hirsutella~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.blockread)
car::Anova(hirst.dna.blockread)
test <- simulateResiduals(fittedModel = hirst.dna.blockread, plot = T, use.u = T)
#readcountnon-significant, fits

#Check if pre crop + read is significant
hirst.dna.pcread <- glmmTMB(Hirsutella~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.pcread)
car::Anova(hirst.dna.pcread)
test <- simulateResiduals(fittedModel = hirst.dna.pcread, plot = T, use.u = T)
#pre crop significant, no fit

#Check if pre crop + block is significant
hirst.dna.pcbl <- glmmTMB(Hirsutella~  pre.crop + block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.pcbl)
car::Anova(hirst.dna.pcbl)
test <- simulateResiduals(fittedModel = hirst.dna.pcbl, plot = T, use.u = T)
#pre crop and block are non-significant, fits

#Check complete
hirst.dna.complete <- glmmTMB(Hirsutella~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hirst.dna.complete)
car::Anova(hirst.dna.complete)
test <- simulateResiduals(fittedModel = hirst.dna.complete, plot = T, use.u = T)
#block2 significant
testZeroInflation(test)#no need

anova(hirst.dna.readcount,hirst.dna.block, hirst.dna.blockread, hirst.dna.complete,hirst.dna.pcread,hirst.dna.pcbl )
#block is the only one significant use random

#test for pre crops
hirst.dna.null <- glmmTMB(Hirsutella~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
hirst.dna.null.off <- glmmTMB(Hirsutella~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hirst.dna.null.off, plot = T)#no fit
hirst.dna.cc <- glmmTMB(Hirsutella~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hirst.dna.cc, plot = T)#fits
car::Anova(hirst.dna.cc)#no sign
hirst.dna.ccrand <- glmmTMB(Hirsutella~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hirst.dna.ccrand, plot = T)#fit
car::Anova(hirst.dna.ccrand) #no sign
hirst.dna.ccrandpc <- glmmTMB(Hirsutella~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hirst.dna.ccrandpc, plot = T)#no fit
car::Anova(hirst.dna.ccrand) #no sign
hirst.dna.ccrandoff <- glmmTMB(Hirsutella~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hirst.dna.ccrandoff, plot = T)#fits
testZeroInflation(test)
car::Anova(hirst.dna.ccrandoff) #sign
hirst.dna.ccoff <- glmmTMB(Hirsutella~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hirst.dna.ccoff, plot = T)#no fit but best model
car::Anova(hirst.dna.ccoff)
hirst.dna.ccpcoff <- glmmTMB(Hirsutella~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hirst.dna.ccpcoff, plot = T)#no fit
car::Anova(hirst.dna.ccpcoff)
hirst.dna.ccpcbloff <- glmmTMB(Hirsutella~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hirst.dna.ccpcbloff, plot = T)#no fit
car::Anova(hirst.dna.ccpcbloff)

#anova
anova(hirst.dna.null,hirst.dna.cc,hirst.dna.ccrand, hirst.dna.ccrandpc) #cc rand is the best and fits
anova(hirst.dna.null.off, hirst.dna.ccrandoff,hirst.dna.ccoff,hirst.dna.ccpcoff,hirst.dna.ccpcbloff)


#choose best model - cc + offset + random - none ofthe model its

hirst.dna.ccrand <- glmmTMB(Hirsutella~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hirst.dna.ccrand, plot = T)#fit
testZeroInflation(test)
car::Anova(hirst.dna.ccrand) #no sign
summary(hirst.dna.ccrand)

#check model
test <- simulateResiduals(fittedModel = hirst.dna.ccrand, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(hirst.dna.ccrand)
testZeroInflation(test)

#EMMEANS
ref_grid(hirst.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(hirst.dna.ccrand, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Haptocillium
```{r}
data.itsgen.dna.t1.s$Haptocillium
hist(data.itsgen.dna.t1.s$Haptocillium,nclass = 1000)
boxplot(data.itsgen.dna.t1.s$Haptocillium~ data.itsgen.dna.t1.s$pre.crop)
boxplot(data.itsgen.dna.t1.s$Haptocillium~ data.itsgen.dna.t1.s$block2)
boxplot(data.itsgen.dna.t1.s$Haptocillium~ data.itsgen.dna.t1.s$cc)

#Check if readcount is significant
hapt.dna.readcount <- glmmTMB(Haptocillium~ log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family = nbinom1(link = "log"))
summary(hapt.dna.readcount)
car::Anova(hapt.dna.readcount)
test <- simulateResiduals(fittedModel = hapt.dna.readcount, plot = T, use.u = T)
#readcount is non-significant, fits

#Check if block is significant
hapt.dna.block <- glmmTMB(Haptocillium~  block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.block)
car::Anova(hapt.dna.block)
test <- simulateResiduals(fittedModel = hapt.dna.block, plot = T, use.u = T)
#block2 is significant,fit

#Check if pre crop
hapt.dna.pc <- glmmTMB(Haptocillium~  pre.crop, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.pc)
car::Anova(hapt.dna.pc)
test <- simulateResiduals(fittedModel = hapt.dna.pc, plot = T, use.u = T)
#pre crop is significant, fits

#Check if block + read is significant
hapt.dna.blockread <- glmmTMB(Haptocillium~  block2 + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.blockread)
car::Anova(hapt.dna.blockread)
test <- simulateResiduals(fittedModel = hapt.dna.blockread, plot = T, use.u = T)
#readcountnon-significant, no fit

#Check if pre crop + read is significant
hapt.dna.pcread <- glmmTMB(Haptocillium~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.pcread)
car::Anova(hapt.dna.pcread)
test <- simulateResiduals(fittedModel = hapt.dna.pcread, plot = T, use.u = T)
#pre crop significant, fits

#Check if pre crop + block is significant
hapt.dna.pcbl <- glmmTMB(Haptocillium~  pre.crop + block2, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.pcbl)
car::Anova(hapt.dna.pcbl)
test <- simulateResiduals(fittedModel = hapt.dna.pcbl, plot = T, use.u = T)
#pre crop and block are significant, fits

#Check complete
hapt.dna.complete <- glmmTMB(Haptocillium~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.dna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(hapt.dna.complete)
car::Anova(hapt.dna.complete)
test <- simulateResiduals(fittedModel = hapt.dna.complete, plot = T, use.u = T)
#block2 significant
testZeroInflation(test)#no need

anova(hapt.dna.readcount,hapt.dna.block, hapt.dna.blockread, hapt.dna.complete,hapt.dna.pcread,hapt.dna.pcbl )
#block is the only one significant use random

#test for pre crops
hapt.dna.null <- glmmTMB(Haptocillium~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log")) 
hapt.dna.null.off <- glmmTMB(Haptocillium~  1,
                        data = data.itsgen.dna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hapt.dna.null.off, plot = T)#no fit
hapt.dna.cc <- glmmTMB(Haptocillium~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hapt.dna.cc, plot = T)#fits
car::Anova(hapt.dna.cc)#no sign
hapt.dna.ccrand <- glmmTMB(Haptocillium~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hapt.dna.ccrand, plot = T)#fit
car::Anova(hapt.dna.ccrand) #no sign
hapt.dna.ccrandpc <- glmmTMB(Haptocillium~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hapt.dna.ccrandpc, plot = T)#fits
car::Anova(hapt.dna.ccrand) #no sign
hapt.dna.ccrandblpc <- glmmTMB(Haptocillium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hapt.dna.ccrandblpc, plot = T)#fits
car::Anova(hapt.dna.ccrandblpc)#no sign
hapt.dna.ccrandoff <- glmmTMB(Haptocillium~  cc+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hapt.dna.ccrandoff, plot = T)#fits
testZeroInflation(test)
car::Anova(hapt.dna.ccrandoff) #sign
hapt.dna.ccoff <- glmmTMB(Haptocillium~  cc,
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hapt.dna.ccoff, plot = T)#no fit but best model
car::Anova(hapt.dna.ccoff)
hapt.dna.ccpcoff <- glmmTMB(Haptocillium~  cc+(1|pre.crop),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hapt.dna.ccpcoff, plot = T)#no fit
car::Anova(hapt.dna.ccpcoff)
hapt.dna.ccpcbloff <- glmmTMB(Haptocillium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = hapt.dna.ccpcbloff, plot = T)#no fit
car::Anova(hapt.dna.ccpcbloff)

#anova
anova(hapt.dna.null,hapt.dna.cc,hapt.dna.ccrand, hapt.dna.ccrandpc) #cc rand is the best and fits
anova(hapt.dna.null.off, hapt.dna.ccrandoff,hapt.dna.ccoff,hapt.dna.ccpcoff,hapt.dna.ccpcbloff)


#choose best model - block and pre crops as random

hapt.dna.ccrandblpc <- glmmTMB(Haptocillium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.dna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = hapt.dna.ccrandblpc, plot = T)#fits
testZeroInflation(test)
car::Anova(hapt.dna.ccrandblpc)#no sign
summary(hapt.dna.ccrandblpc)

#check model
test <- simulateResiduals(fittedModel = hapt.dna.ccrandblpc, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(hapt.dna.ccrandblpc)
testZeroInflation(test)

#EMMEANS
ref_grid(hapt.dna.pc)
#emm.off<-emmeans(var.dna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(hapt.dna.ccrandblpc, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


######################################################################################################################################
RNA

RNA
```{r}
length(which(data.itsgen.rna.t1.s$Arthrobotrys > 0))#(112/129)
length(which(data.itsgen.rna.t1.s$Dactylella> 0)) #(3/129)
length(which(data.itsgen.rna.t1.s$Monacrosporium> 0)) #(11/129)
length(which(data.itsgen.rna.t1.s$Orbilia > 0))#(2/129)
length(which(data.itsgen.rna.t1.s$Trichoderma > 0))#(85/129)
length(which(data.itsgen.rna.t1.s$Fusarium> 0)) #(106/129)
length(which(data.itsgen.rna.t1.s$Haptocillium > 0))#(1/129)
length(which(data.itsgen.rna.t1.s$Hirsutella> 0)) #(3/129)
length(which(data.itsgen.rna.t1.s$Coprinus> 0)) #(1/129)
length(which(data.itsgen.rna.t1.s$Coprinellus > 0))#(3/129)
length(which(data.itsgen.rna.t1.s$Stropharia > 0))#(1/129)
length(which(data.itsgen.rna.t1.s$Paraglomus> 0)) #(1/129) 
length(which(data.itsgen.rna.t1.s$Mortierella > 0))#(93/129)
length(which(data.itsgen.rna.t1.s$Penicillium > 0))#(44/130)
length(which(data.itsgen.rna.t1.s$Nematoctonus > 0))#(6/130)
```


Arthrobotrys
```{r}
data.itsgen.rna.t1.s$Arthrobotrys
hist(data.itsgen.rna.t1.s$Arthrobotrys,nclass = 1000)
boxplot(data.itsgen.rna.t1.s$Arthrobotrys ~ data.itsgen.rna.t1.s$pre.crop)
boxplot(data.itsgen.rna.t1.s$Arthrobotrys ~ data.itsgen.rna.t1.s$cc)

#Check if readcount is significant
arth.rna.readcount <- glmmTMB(Arthrobotrys ~ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family = nbinom1(link = "log"))
summary(arth.rna.readcount)
car::Anova(arth.rna.readcount)
test <- simulateResiduals(fittedModel = arth.rna.readcount, plot = T, use.u = T)
#readcount is significant but doesn't fit

#Check if block is significant
arth.rna.block <- glmmTMB(Arthrobotrys ~  block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.block)
car::Anova(arth.rna.block)
test <- simulateResiduals(fittedModel = arth.rna.block, plot = T, use.u = T)
#block2 is non-significant, fits

#Check if pre crop
arth.rna.pc <- glmmTMB(Arthrobotrys ~  pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.pc)
car::Anova(arth.rna.pc)
test <- simulateResiduals(fittedModel = arth.rna.pc, plot = T, use.u = T)
#pre crop is significant, doesn't fit

#Check if block + read is significant
arth.rna.blockread <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.blockread)
car::Anova(arth.rna.blockread)
test <- simulateResiduals(fittedModel = arth.rna.blockread, plot = T, use.u = T)
#readcount is the only significant - but doesn't fit

#Check if pre crop + read is significant
arth.rna.pcread <- glmmTMB(Arthrobotrys ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.pcread)
car::Anova(arth.rna.pcread)
test <- simulateResiduals(fittedModel = arth.rna.pcread, plot = T, use.u = T)
#pre crop and reads are significant but doesn't fit

#Check if block - read count and pre crop are significant
arth.rna.blockreadpc <- glmmTMB(Arthrobotrys ~  block2 + log(readcount.tot)+pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.blockreadpc)
car::Anova(arth.rna.blockreadpc)
test <- simulateResiduals(fittedModel = arth.rna.blockreadpc, plot = T, use.u = T)
#readcount and pre crop are significant - fits

#Check complete
arth.rna.complete <- glmmTMB(Arthrobotrys ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(arth.rna.complete)
car::Anova(arth.rna.complete)
test <- simulateResiduals(fittedModel = arth.rna.complete, plot = T, use.u = T)
#reads and pre crop are significant. fits

anova(arth.rna.readcount,arth.rna.block, arth.rna.blockread, arth.rna.blockreadpc, arth.rna.complete,arth.rna.pcread ) #- use block as random

#test for pre crops
arth.rna.null <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log")) 
arth.rna.null.off <- glmmTMB(Arthrobotrys ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.null.off, plot = T)#no fit
arth.rna.cc <- glmmTMB(Arthrobotrys ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.cc, plot = T)#no fit
car::Anova(arth.rna.cc)
arth.rna.ccrand <- glmmTMB(Arthrobotrys ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.ccrand, plot = T)#no fit
arth.rna.ccrandpc <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = arth.rna.ccrandpc, plot = T)#no fit
car::Anova(arth.rna.ccrandpc)
arth.rna.ccrandoff <- glmmTMB(Arthrobotrys ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.ccrandoff, plot = T)#no fit
car::Anova(arth.rna.ccrandoff)
arth.rna.ccoff <- glmmTMB(Arthrobotrys ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.ccoff, plot = T)#no fit but best model
car::Anova(arth.rna.ccoff)
arth.rna.ccpcoff <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.ccpcoff, plot = T)#no fit
car::Anova(arth.rna.ccpcoff)
arth.rna.ccpcbloff <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.ccpcbloff, plot = T)#no fit
car::Anova(arth.rna.ccpcbloff)

#anova
anova(arth.rna.null,arth.rna.cc,arth.rna.ccrand, arth.rna.ccrandpc)
anova(arth.rna.null.off, arth.rna.ccrandoff,arth.rna.ccoff,arth.rna.ccpcoff,arth.rna.ccpcbloff)
#choose

arth.rna.ccpcoff <- glmmTMB(Arthrobotrys ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = arth.rna.ccpcoff, plot = T)#no fit
car::Anova(arth.rna.ccpcoff)
summary(arth.rna.ccpcoff)

#check model
test <- simulateResiduals(fittedModel = arth.rna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(arth.rna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(arth.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(arth.rna.ccpcoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)

#pc
arth.rna.pc <- glmmTMB(Arthrobotrys ~  pre.crop,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))

summary(arth.rna.pc)
car::Anova (arth.rna.pc)
emm.res <- emmeans(arth.rna.pc, "pre.crop", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Trichoderma
```{r}
data.itsgen.rna.t1.s$Trichoderma
hist(data.itsgen.rna.t1.s$Trichoderma,nclass = 1000)
boxplot(data.itsgen.rna.t1.s$Trichoderma ~ data.itsgen.rna.t1.s$pre.crop)
boxplot(data.itsgen.rna.t1.s$Trichoderma ~ data.itsgen.rna.t1.s$block2)
boxplot(data.itsgen.rna.t1.s$Trichoderma ~ data.itsgen.rna.t1.s$cc)

#Check if readcount is significant
trich.rna.readcount <- glmmTMB(Trichoderma ~ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family = nbinom1(link = "log"))
summary(trich.rna.readcount)
car::Anova(trich.rna.readcount)
test <- simulateResiduals(fittedModel = trich.rna.readcount, plot = T, use.u = T)
#readcount is significant , but no fit

#Check if block is significant
trich.rna.block <- glmmTMB(Trichoderma ~  block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.block)
car::Anova(trich.rna.block)
test <- simulateResiduals(fittedModel = trich.rna.block, plot = T, use.u = T)
#block2 is non-significant, doesn't fit

#Check if pre crop
trich.rna.pc <- glmmTMB(Trichoderma ~  pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.pc)
car::Anova(trich.rna.pc)
test <- simulateResiduals(fittedModel = trich.rna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
trich.rna.blockread <- glmmTMB(Trichoderma ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.blockread)
car::Anova(trich.rna.blockread)
test <- simulateResiduals(fittedModel = trich.rna.blockread, plot = T, use.u = T)
#readcount significant, no fits

#Check if pre crop + read is significant
trich.rna.pcread <- glmmTMB(Trichoderma ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.pcread)
car::Anova(trich.rna.pcread)
test <- simulateResiduals(fittedModel = trich.rna.pcread, plot = T, use.u = T)
#readcount is the only significant - no fit


#Check complete
trich.rna.complete <- glmmTMB(Trichoderma ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(trich.rna.complete)
car::Anova(trich.rna.complete)
test <- simulateResiduals(fittedModel = trich.rna.complete, plot = T, use.u = T)
#read count significant, but doesn't fit

anova(trich.rna.readcount,trich.rna.block, trich.rna.blockread, trich.rna.complete,trich.rna.pcread )

#test for pre crops
trich.rna.null <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log")) 
trich.rna.null.off <- glmmTMB(Trichoderma ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.null.off, plot = T)
trich.rna.cc <- glmmTMB(Trichoderma ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.rna.cc, plot = T)
trich.rna.ccrand <- glmmTMB(Trichoderma ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.rna.ccrand, plot = T)
trich.rna.ccrandpc <- glmmTMB(Trichoderma ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = trich.rna.ccrandpc, plot = T)
car::Anova(trich.rna.ccrand)
trich.rna.ccrandoff <- glmmTMB(Trichoderma ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.ccrandoff, plot = T)
testZeroInflation(test)
car::Anova(trich.rna.ccrandoff)
trich.rna.ccoff <- glmmTMB(Trichoderma ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.ccoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(trich.rna.ccoff)
trich.rna.ccpcoff <- glmmTMB(Trichoderma ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.ccpcoff, plot = T)#no fit
testZeroInflation(test)
car::Anova(trich.rna.ccpcoff)
trich.rna.ccpcbloff <- glmmTMB(Trichoderma ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.ccpcbloff, plot = T)#no fit
car::Anova(trich.rna.ccpcbloff)

#anova
anova(trich.rna.null,trich.rna.cc,trich.rna.ccrand, trich.rna.ccrandpc)
anova(trich.rna.null.off, trich.rna.ccrandoff,trich.rna.ccoff,trich.rna.ccpcoff,trich.rna.ccpcbloff)

#choose best model - cc + offset + random - none ofthe model its

trich.rna.ccoff <- glmmTMB(Trichoderma ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = trich.rna.ccoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(trich.rna.ccoff)
summary(trich.rna.ccoff)

#check model
test <- simulateResiduals(fittedModel = trich.rna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(trich.rna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(trich.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(trich.rna.ccoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Fusarium
```{r}
data.itsgen.rna.t1.s$Fusarium
hist(data.itsgen.rna.t1.s$Fusarium,nclass = 1000)
boxplot(data.itsgen.rna.t1.s$Fusarium~ data.itsgen.rna.t1.s$pre.crop)
boxplot(data.itsgen.rna.t1.s$Fusarium~ data.itsgen.rna.t1.s$block2)
boxplot(data.itsgen.rna.t1.s$Fusarium~ data.itsgen.rna.t1.s$cc)

#Check if readcount is significant
fus.rna.readcount <- glmmTMB(Fusarium~ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family = nbinom1(link = "log"))
summary(fus.rna.readcount)
car::Anova(fus.rna.readcount)
test <- simulateResiduals(fittedModel = fus.rna.readcount, plot = T, use.u = T)
#readcount is significant but no fit

#Check if block is significant
fus.rna.block <- glmmTMB(Fusarium~  block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.block)
car::Anova(fus.rna.block)
test <- simulateResiduals(fittedModel = fus.rna.block, plot = T, use.u = T)
#block2 is significant, fits

#Check if pre crop
fus.rna.pc <- glmmTMB(Fusarium~  pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.pc)
car::Anova(fus.rna.pc)
test <- simulateResiduals(fittedModel = fus.rna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
fus.rna.blockread <- glmmTMB(Fusarium~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.blockread)
car::Anova(fus.rna.blockread)
test <- simulateResiduals(fittedModel = fus.rna.blockread, plot = T, use.u = T)
#readcount and block significant, no fit

#Check if pre crop + read is significant
fus.rna.pcread <- glmmTMB(Fusarium~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.pcread)
car::Anova(fus.rna.pcread)
test <- simulateResiduals(fittedModel = fus.rna.pcread, plot = T, use.u = T)
#readcount and pre crop are significant - no fit

#Check if pre crop + block is significant
fus.rna.pcbl <- glmmTMB(Fusarium~  pre.crop + block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.pcbl)
car::Anova(fus.rna.pcbl)
test <- simulateResiduals(fittedModel = fus.rna.pcbl, plot = T, use.u = T)
#pre crop and block are significant - no fit

#Check if pre crop + block + read count is significant
fus.rna.pcblread <- glmmTMB(Fusarium~  pre.crop + block2+ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.pcblread)
car::Anova(fus.rna.pcblread)
test <- simulateResiduals(fittedModel = fus.rna.pcblread, plot = T, use.u = T)
#all significant, no fit

#Check complete
fus.rna.complete <- glmmTMB(Fusarium~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(fus.rna.complete)
car::Anova(fus.rna.complete)
test <- simulateResiduals(fittedModel = fus.rna.complete, plot = T, use.u = T)
#all significant, no fit

anova(fus.rna.readcount,fus.rna.block, fus.rna.blockread, fus.rna.complete,fus.rna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
fus.rna.null <- glmmTMB(Fusarium~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log")) 
fus.rna.null.off <- glmmTMB(Fusarium~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.null.off, plot = T)#no fit
fus.rna.cc <- glmmTMB(Fusarium~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.cc, plot = T)#no fit
fus.rna.ccrand <- glmmTMB(Fusarium~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.ccrand, plot = T)#no fit
fus.rna.ccrandpc <- glmmTMB(Fusarium~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = fus.rna.ccrandpc, plot = T)#no fit
car::Anova(fus.rna.ccrand)
fus.rna.ccrandoff <- glmmTMB(Fusarium~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.ccrandoff, plot = T)#no fit
testZeroInflation(test)
car::Anova(fus.rna.ccrandoff)
fus.rna.ccoff <- glmmTMB(Fusarium~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.ccoff, plot = T)#no fit 
car::Anova(fus.rna.ccoff)
fus.rna.ccpcoff <- glmmTMB(Fusarium~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.ccpcoff, plot = T)#no fit
car::Anova(fus.rna.ccpcoff)
fus.rna.ccpcbloff <- glmmTMB(Fusarium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.ccpcbloff, plot = T)#no fit
car::Anova(fus.rna.ccpcbloff)

#anova
anova(fus.rna.null,fus.rna.cc,fus.rna.ccrand, fus.rna.ccrandpc)
anova(fus.rna.null.off, fus.rna.ccrandoff,fus.rna.ccoff,fus.rna.ccpcoff,fus.rna.ccpcbloff)


#choose best model - cc + offset + random - none ofthe model its

fus.rna.ccpcbloff <- glmmTMB(Fusarium~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = fus.rna.ccpcbloff, plot = T)#no fit
testZeroInflation(test)
car::Anova(fus.rna.ccpcbloff)
summary(fus.rna.ccpcbloff)

#check model
test <- simulateResiduals(fittedModel = fus.rna.ccpcbloff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(fus.rna.ccpcbloff)
testZeroInflation(test)

#EMMEANS
ref_grid(fus.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(fus.rna.ccpcbloff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```

Mortierella
```{r}
data.itsgen.rna.t1.s$Mortierella
hist(data.itsgen.rna.t1.s$Mortierella,nclass = 1000)
boxplot(data.itsgen.rna.t1.s$Mortierella~ data.itsgen.rna.t1.s$pre.crop)
boxplot(data.itsgen.rna.t1.s$Mortierella~ data.itsgen.rna.t1.s$block2)
boxplot(data.itsgen.rna.t1.s$Mortierella~ data.itsgen.rna.t1.s$cc)

#Check if readcount is significant
mort.rna.readcount <- glmmTMB(Mortierella~ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family = nbinom1(link = "log"))
summary(mort.rna.readcount)
car::Anova(mort.rna.readcount)
test <- simulateResiduals(fittedModel = mort.rna.readcount, plot = T, use.u = T)
#readcount is significant but no fit

#Check if block is significant
mort.rna.block <- glmmTMB(Mortierella~  block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.block)
car::Anova(mort.rna.block)
test <- simulateResiduals(fittedModel = mort.rna.block, plot = T, use.u = T)
#block2 is non-significant, no fit

#Check if pre crop
mort.rna.pc <- glmmTMB(Mortierella~  pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.pc)
car::Anova(mort.rna.pc)
test <- simulateResiduals(fittedModel = mort.rna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
mort.rna.blockread <- glmmTMB(Mortierella~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.blockread)
car::Anova(mort.rna.blockread)
test <- simulateResiduals(fittedModel = mort.rna.blockread, plot = T, use.u = T)
#readcount  significant, no fit

#Check if pre crop + read is significant
mort.rna.pcread <- glmmTMB(Mortierella~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.pcread)
car::Anova(mort.rna.pcread)
test <- simulateResiduals(fittedModel = mort.rna.pcread, plot = T, use.u = T)
#readcount is the only significant - no fit


#Check complete
mort.rna.complete <- glmmTMB(Mortierella~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(mort.rna.complete)
car::Anova(mort.rna.complete)
test <- simulateResiduals(fittedModel = mort.rna.complete, plot = T, use.u = T)
#cc and reads are significant, no fit
testZeroInflation(test)#probably

#Check complete with zero inflation
mort.rna.completezi <- glmmTMB(Mortierella~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"),
                         ziformula = ~1)
summary(mort.rna.completezi)
car::Anova(mort.rna.completezi)
test <- simulateResiduals(fittedModel = mort.rna.completezi, plot = T, use.u = T)
#cc and reads are significant, fits
testZeroInflation(test)#probably

anova(mort.rna.readcount,mort.rna.block, mort.rna.blockread, mort.rna.complete,mort.rna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
mort.rna.null <- glmmTMB(Mortierella~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log")) 
mort.rna.null.off <- glmmTMB(Mortierella~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.rna.null.off, plot = T)#no fit
mort.rna.cc <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.rna.cc, plot = T)#no fit
mort.rna.ccrand <- glmmTMB(Mortierella~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.rna.ccrand, plot = T)#no fit
mort.rna.ccrandpc <- glmmTMB(Mortierella~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = mort.rna.ccrandpc, plot = T)#no fit
car::Anova(mort.rna.ccrand)
mort.rna.ccrandoff <- glmmTMB(Mortierella~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.rna.ccrandoff, plot = T)#no fit but best model
testZeroInflation(test)
car::Anova(mort.rna.ccrandoff)

#correct
mort.rna.ccoff <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.rna.ccoff, plot = T)#no fit but best model
car::Anova(mort.rna.ccoff)

mort.rna.ccoffzi <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot),
                      ziformula = ~1)
test <- simulateResiduals(fittedModel = mort.rna.ccoffzi, plot = T)#no fit but best model
car::Anova(mort.rna.ccoffzi)

mort.rna.ccpcoff <- glmmTMB(Mortierella~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.rna.ccpcoff, plot = T)#no fit
car::Anova(mort.rna.ccpcoff)
mort.rna.ccpcbloff <- glmmTMB(Mortierella~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = mort.rna.ccpcbloff, plot = T)#no fit
car::Anova(mort.rna.ccpcbloff)

#anova
anova(mort.rna.null,mort.rna.cc,mort.rna.ccrand, mort.rna.ccrandpc)
anova(mort.rna.null.off, mort.rna.ccrandoff,mort.rna.ccoff,mort.rna.ccpcoff,mort.rna.ccpcbloff)


#choose best model - 

mort.rna.ccoffzi <- glmmTMB(Mortierella~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot),
                      ziformula = ~1)
test <- simulateResiduals(fittedModel = mort.rna.ccoffzi, plot = T)#no fit but best model
car::Anova(mort.rna.ccoffzi)
summary(mort.rna.ccoffzi)
knitr::kable(summary(mort.rna.ccoffzi)$coefficients, digits = 4)


#check model
test <- simulateResiduals(fittedModel = mort.rna.ccoffzi, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(mort.rna.ccoffzi)
testZeroInflation(test)

#EMMEANS
ref_grid(mort.rna.pc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(mort.rna.ccoffzi, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


Penicillium
```{r}
data.itsgen.rna.t1.s$Penicillium
hist(data.itsgen.rna.t1.s$Penicillium,nclass = 1000)
boxplot(data.itsgen.rna.t1.s$Penicillium ~ data.itsgen.rna.t1.s$pre.crop)
boxplot(data.itsgen.rna.t1.s$Penicillium ~ data.itsgen.rna.t1.s$block2)
boxplot(data.itsgen.rna.t1.s$Penicillium ~ data.itsgen.rna.t1.s$cc)

#Check if readcount is significant
pen.rna.readcount <- glmmTMB(Penicillium ~ log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family = nbinom1(link = "log"))
summary(pen.rna.readcount)
car::Anova(pen.rna.readcount)
test <- simulateResiduals(fittedModel = pen.rna.readcount, plot = T, use.u = T)
#readcount non significant - fit

#Check if block is significant
pen.rna.block <- glmmTMB(Penicillium ~  block2, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.block)
car::Anova(pen.rna.block)
test <- simulateResiduals(fittedModel = pen.rna.block, plot = T, use.u = T)
#block2 is non-significant, doesn't fit

#Check if pre crop
pen.rna.pc <- glmmTMB(Penicillium ~  pre.crop, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.pc)
car::Anova(pen.rna.pc)
test <- simulateResiduals(fittedModel = pen.rna.pc, plot = T, use.u = T)
#pre crop is non-significant, no fit

#Check if block + read is significant
pen.rna.blockread <- glmmTMB(Penicillium ~  block2 + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.blockread)
car::Anova(pen.rna.blockread)
test <- simulateResiduals(fittedModel = pen.rna.blockread, plot = T, use.u = T)
#readcount significant, no fit

#Check if pre crop + read is significant
pen.rna.pcread <- glmmTMB(Penicillium ~  pre.crop + log(readcount.tot), 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.pcread)
car::Anova(pen.rna.pcread)
test <- simulateResiduals(fittedModel = pen.rna.pcread, plot = T, use.u = T)
#readcount is the only significant - - no fit


#Check complete
pen.rna.complete <- glmmTMB(Penicillium ~ pre.crop+ block2 + log(readcount.tot)+cc, 
                         data = data.itsgen.rna.t1.s , 
                         family =  nbinom1(link = "log"))
summary(pen.rna.complete)
car::Anova(pen.rna.complete)
test <- simulateResiduals(fittedModel = pen.rna.complete, plot = T, use.u = T)
#block, readcount  and cc are significant but doesn't fit

anova(pen.rna.readcount,pen.rna.block, pen.rna.blockread, pen.rna.blockreadpc, pen.rna.complete,pen.rna.pcread )
#complete is the best - secodn is block - read

#test for pre crops
pen.rna.null <- glmmTMB(Penicillium ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log")) 
pen.rna.null.off <- glmmTMB(Penicillium ~  1,
                        data = data.itsgen.rna.t1.s , 
                        family = nbinom1(link = "log"),
                        offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.null.off, plot = T)#no fit
pen.rna.cc <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.rna.cc, plot = T)#no fit
pen.rna.ccrand <- glmmTMB(Penicillium ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.rna.ccrand, plot = T)#no fit
pen.rna.ccrandpc <- glmmTMB(Penicillium ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"))
test <- simulateResiduals(fittedModel = pen.rna.ccrandpc, plot = T)#no fit
car::Anova(pen.rna.ccrand)
pen.rna.ccrandoff <- glmmTMB(Penicillium ~  cc+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.ccrandoff, plot = T)#no fit
testZeroInflation(test)
car::Anova(pen.rna.ccrandoff)
pen.rna.ccoff <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.ccoff, plot = T)#no fit but best model
car::Anova(pen.rna.ccoff)
pen.rna.ccpcoff <- glmmTMB(Penicillium ~  cc+(1|pre.crop),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.ccpcoff, plot = T)#no fit
car::Anova(pen.rna.ccpcoff)
pen.rna.ccpcbloff <- glmmTMB(Penicillium ~  cc+(1|pre.crop)+(1|block2),
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))
test <- simulateResiduals(fittedModel = pen.rna.ccpcbloff, plot = T)#no fit
car::Anova(pen.rna.ccpcbloff)

#anova
anova(pen.rna.null,pen.rna.cc,pen.rna.ccrand, pen.rna.ccrandpc)
anova(pen.rna.null.off, pen.rna.ccrandoff,pen.rna.ccoff,pen.rna.ccpcoff,pen.rna.ccpcbloff)
#choose best model - cc + offset + random - none ofthe model its

pen.rna.ccoff <- glmmTMB(Penicillium ~  cc,
                      data = data.itsgen.rna.t1.s , 
                      family = nbinom1 (link = "log"),
                      offset = log(readcount.tot))

test <- simulateResiduals(fittedModel = pen.rna.ccoff, plot = T)#no fit
car::Anova(pen.rna.ccoff)
knitr::kable(summary(pen.rna.ccoff)$coefficients, digits = 4)
summary(pen.rna.ccoff)

#check model
test <- simulateResiduals(fittedModel = pen.rna.ccoff, plot = T)
testResiduals(test, plot = T)
test_dispersion <- testDispersion(pen.rna.ccoff)
testZeroInflation(test)

#EMMEANS
ref_grid(pen.rna.cc)
#emm.off<-emmeans(var.rna.ccrandoffzi, "cc", type = "response") #lp for log values
emm.res <- emmeans(pen.rna.ccoff, "cc", type = "response")
cld(emm.res, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE)
```


#plots only most abundance
```{r}
data.itsgen.dna.t1.s.long <- data.itsgen.dna.t1.s %>% 
  pivot_longer(cols = c(Penicillium, Mortierella,Fusarium,Trichoderma,Hirsutella,Haptocillium) , 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
              mutate (Rel.abundance.DNA = 100*(Abundance/readcount.tot), keep = "all") 
data.itsgen.dna.t1.s.long$pre.crop <- fct_relevel(data.itsgen.dna.t1.s.long$pre.crop, "bo", "ry", "ir", "er" )
  
plot.ant.its.dna.t1<- data.itsgen.dna.t1.s.long %>%  
                        ggplot (mapping = aes(x=cc, y = Rel.abundance.DNA))+
                        geom_boxplot()+
                        scale_y_continuous(labels=function(x) paste0(x,"%"), limits = c(0,7))+
                        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
                        labs(title = "Relative abundance of fungal antaginists in DNA", y = "Relative abundance")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow = 2, ncol = 3)
plot.ant.its.dna.t1

data.itsgen.rna.t1.s.long <- data.itsgen.rna.t1.s %>% 
  pivot_longer(cols = c(Penicillium, Mortierella,Fusarium,Trichoderma) , 
               names_to = "Genus", 
               values_to = "Abundance") %>% 
  mutate (Rel.abundance.RNA = 100*(Abundance/readcount.tot), keep = "all") 

data.itsgen.rna.t1.s.long$pre.crop <- fct_relevel(data.itsgen.rna.t1.s.long$pre.crop, "bo", "ry", "ir", "er" )
plot.ant.its.rna.t1<- data.itsgen.rna.t1.s.long %>%  
                        ggplot (mapping = aes(x=cc, y = Rel.abundance.RNA))+
                        geom_boxplot()+
                        scale_y_continuous(labels=function(x) paste0(x,"%"), limits = c(0,7))+
                        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
                        labs(title = "Relative abundance of fungal antaginists in RNA", y = "Relative abundance")+
                        facet_wrap(vars(Genus), scales = "fixed", strip.position = "top", nrow =2, ncol = 3)
plot.ant.its.rna.t1

library(cowplot)
ant.t1 <- plot_grid(plot.ant.its.dna.t1, 
                    plot.ant.its.rna.t1,
                    align = "hv",
                    ncol = 1, nrow = 2)
ant.t1 
```